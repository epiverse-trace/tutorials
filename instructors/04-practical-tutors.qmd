---
title: "Week 4: Simulate transmission and model interventions"
format: 
  html: # learners solutions
    embed-resources: true
    output-file: "04-practical-solutions"
  docx: # learners practical
    output-file: "04-practical-guide"
  gfm: default # instructors
keep-md: false
format-links: false
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

::: {.content-hidden when-format="html"}

<!-- visible for instructors only -->
<!-- practical-week.md is generated from practical-week.qmd. Please edit that file -->
<!-- commit .md and .qmd files together -->

<!-- does not work for instructors text messages -->

:::

::: {.content-hidden when-format="docx"}

<!-- works for text on html and MD only -->

This practical is based in the following tutorial episodes:

- <https://epiverse-trace.github.io/tutorials-late/simulating-transmission.html>
- <https://epiverse-trace.github.io/tutorials-late/modelling-interventions.html>


:::


::: {.content-visible when-format="docx"}

{{< include _welcome.qmd >}}

:::

# Practical

This practical has three activities.

## Activity 1: Generate Disease Trajectories Across Age Groups

Generate disease trajectories of **infectious individuals** and **new infections** across age groups using the following available inputs:

- Social contact matrix
- Age group of the infectious population
- Disease parameters (basic reproduction number, pre-infectious period, infectious period)

**Steps:**  

Open the file `04-practical-activity-1.R` and complete all the lines marked with `#<COMPLETE>`, following the detailed steps provided within the R file.

**Questions:**

Within your room, Write your answers to these questions:

- What are the time and size of the epidemic peak for *infectious individuals* in each age group? Use the table output.
- Compare and describe the similarities and differences between these two outputs: the table with the epidemic peak of *infectious individuals* across age groups, and the plot of *new infections* across age groups.
- Compare: What differences do you observe compared to the outputs from other rooms (if available)?

### Inputs

| Room | Country | Survey Link |
|---|---|---|
| 1 | Italy | <https://doi.org/10.5281/zenodo.3874557> |
| 2 | Vietnam | <https://doi.org/10.5281/zenodo.3874802> |
| 3 | Zimbabwe | <https://doi.org/10.5281/zenodo.3886638> |

| Parameter | Value | Notes |
|---|---|---|
| Age Limits | 0, 20, 40 | Age group cutoffs |
| Infectious Population | 1 / 1,000,000 | 1 infectious individual per million people in the Age group 20-40 |
| Basic Reproduction Number | 1.46 | R₀ value for influenza |
| Pre-infectious Period | 3 days | Incubation before becoming infectious |
| Infectious Period | 7 days | Duration of infectiousness |
| Time end | 1000 days | Total simulation time |



::: {.content-visible when-format="docx"}

### Your Code

Use the file `04-practical-activity-1.R`


### Your Answers

Room 1

| **Output** | **Paste below** |
|---|---|
| Plot of *all compartments* and age groups |  |
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* across age groups |  |

Write your answers to the questions above:

```







```


------------------------

Room 2

| **Output** | **Paste below** |
|---|---|
| Plot of *all compartments* and age groups |  |
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* across age groups |  |

Write your answers to the questions above:

```







```


------------------------

Room 3

| **Output** | **Paste below** |
|---|---|
| Plot of *all compartments* and age groups |  |
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* across age groups |  |

Write your answers to the questions above:

```







```

:::



::: {.content-visible unless-format="docx"}

### Solution

<!-- visible for instructors and learners after practical (solutions) -->

#### Outputs

| country | all compartments | new infections |
| -------- | -------- | -------- |
| Italy | ![image](https://hackmd.io/_uploads/SyVnWdXvle.png) | ![image](https://hackmd.io/_uploads/Syua-OQPeg.png) |

```
epidemics::epidemic_peak(data = simulate_baseline)
#>    demography_group compartment  time    value
#>              <char>      <char> <num>    <num>
#> 1:           [0,20)  infectious   320 513985.5
#> 2:          [20,40)  infectious   328 560947.3
#> 3:              40+  infectious   329 932989.8
```

| country | all compartments | new infections |
| -------- | -------- | -------- |
| Vietnam | ![image](https://hackmd.io/_uploads/BJFgQ_mvel.png) | ![image](https://hackmd.io/_uploads/HJ8-Qdmvlg.png) |

```
epidemics::epidemic_peak(data = simulate_baseline)
#>    demography_group compartment  time     value
#>              <char>      <char> <num>     <num>
#> 1:           [0,20)  infectious   325  929142.4
#> 2:          [20,40)  infectious   322  975411.0
#> 3:              40+  infectious   317 1053391.8
```

| country | all compartments | new infections |
| -------- | -------- | -------- |
| Zimbabwe | ![image](https://hackmd.io/_uploads/HJ_t7dXwgg.png) | ![image](https://hackmd.io/_uploads/Sk_9mdXDgx.png) |

```
epidemics::epidemic_peak(data = simulate_baseline)
#>    demography_group compartment  time    value
#>              <char>      <char> <num>    <num>
#> 1:           [0,20)  infectious   322 277709.4
#> 2:          [20,40)  infectious   321 188967.9
#> 3:              40+  infectious   317 111165.7
```

#### Interpretation

Interpretation template:

+ In an age-structured SEIR epidemic model for influenza transmission in Zimbabwe, the demographic group aged 0 to 20 years (`[0,20]`) reaches its peak number of *infectious individuals* on day `322`, with a peak size of `277,709` individuals.

Compare output types:

+ `epidemics::epidemic_peak(data = simulate_baseline)`
    + The table output gives exact values for time and size of peak for *infectious individuals* across age groups.
+ `epidemics::new_infections(data = simulate_baseline)`
    + We can plot the trajectories of *new infections* across age groups, but not get exact value for time and size of peak directly.
    + We can make qualitative comparisons between countries or scenarios.
+ Comparing plots:
    + The peak size of *new infections* is lower than the peak size of *infectious individuals*. 
        + New infections are defined as the daily outflow of individuals from the susceptible to the exposed compartment. 
        + Infectious are defined as the total number of cumulative amount of individuals in the infectious compartment at each time. 
    + The peak time may be similar in both outputs.
    + Other packages that can estimate the trend of new infections are `{EpiNow2}` and `{epichains}`.

Comparison between rooms:

- Population structure and age-specific social contact patterns in each country influence the progression of disease transmission. 
- Using `{socialmixr}`, the symmetric contact matrix contains the *mean number of contacts* that an individual in each age group (row) reports having with individuals of the same or another age group (column).
    + Note: The contact matrix may look asymmetric, but it is *symmetric in total contacts*. That is, the total number of contacts from one group to another is the same in both directions — check this by multiplying the mean contacts by the population size for each group.

| Italy | Vietnam | Zimbabwe |
| --- | --- | --- |
| ![image](https://hackmd.io/_uploads/HyYOZ57Dll.png) | ![image](https://hackmd.io/_uploads/HkTjb9QDxl.png) | ![image](https://hackmd.io/_uploads/Bkrhx5Xvlx.png) |

Figures using `socialmixr::matrix_plot(contact_data$matrix * contact_data$demography$proportion)`

:::



## Activity 2: Compare the Baseline Scenario with a Single Intervention

Compare the disease trajectories of **new infections** in the whole population under two conditions: 

1. The baseline scenario (no intervention)
2. A scenario with a single intervention

Use the following inputs to define and explore the intervention scenario:

- Start time of the intervention
- Duration of the intervention
- Type of intervention (on contact reduction, on transmission rate reduction, or vaccination)
- Reduction or Vaccination rate

**Steps:**  

Open the file `04-practical-activity-2.R` and complete all the lines marked with `#<COMPLETE>`, following the detailed steps provided within the R file.

**Questions:**

Within your room, write your answers to these questions:

- Does the impact of the intervention, compared to the baseline, align with your expectations? Why or why not? Use all the available outputs.
- Interpret the results: How would you explain these findings to a decision-maker?
- Compare: What differences do you observe compared to the outputs from other rooms (if available)?

### Inputs

| Room | Country | Survey Link |
|---|---|---|
| 1,2,3 | Zimbabwe | <https://doi.org/10.5281/zenodo.3886638> |

| Room | Intervention | Reduction/Vaccination rate | Time begin (day) | Duration (days) |
|---|---|---|---|---|
| 1 | School closure | Age 0–19: 0.5; Age 20+: 0.01 | 200 | 250 |
| 2 | Mask mandate | All ages: 0.163 | 200 | 250 |
| 3 | Vaccination | All ages: 0.001 | 200 | 250 |

::: {.content-visible when-format="docx"}

### Your Code

Use the file `04-practical-activity-2.R`


### Your Answers

Room 1

| **Output** | **Paste below** |
|---|---|
| Plot of *all compartments* and age groups |  |
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* in the whole population |  |

Write your answers to the questions above:

```







```


------------------------

Room 2

| **Output** | **Paste below** |
|---|---|
| Plot of *all compartments* and age groups |  |
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* in the whole population |  |

Write your answers to the questions above:

```







```


------------------------

Room 3

| **Output** | **Paste below** |
|---|---|
| Plot of *all compartments* and age groups |  |
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* in the whole population |  |

Write your answers to the questions above:

```







```

:::



::: {.content-visible unless-format="docx"}

### Solution

<!-- visible for instructors and learners after practical (solutions) -->

#### Outputs

| intervention | all compartments | new infections |
|---|---|---|
| School closure | ![image](https://hackmd.io/_uploads/SJcXBqmwxg.png) | ![image](https://hackmd.io/_uploads/B1G2HcXwlx.png) |

```
epidemics::epidemic_peak(simulate_intervention)
#>    demography_group compartment  time     value
#> 1:           [0,20)  infectious   568 190371.93
#> 2:          [20,40)  infectious   566 121626.39
#> 3:              40+  infectious   562  70255.15
```

| intervention | all compartments | new infections |
|---|---|---|
| Mask mandate | ![image](https://hackmd.io/_uploads/S12cIcXPex.png) | ![image](https://hackmd.io/_uploads/BytgP5QPll.png) |

```
epidemics::epidemic_peak(simulate_intervention)

#>    demography_group compartment  time    value
#> 1:           [0,20)  infectious   380 88058.78
#> 2:          [20,40)  infectious   378 61155.76
#> 3:              40+  infectious   374 38143.96

```

| intervention | all compartments | new infections |
|---|---|---|
| Vaccination | ![image](https://hackmd.io/_uploads/rJMVOcXPeg.png) | ![image](https://hackmd.io/_uploads/r1p_O9Qwgx.png) |

```
epidemics::epidemic_peak(data = simulate_intervention)
#>    demography_group compartment  time     value
#> 1:           [0,20)  infectious   318 155276.44
#> 2:          [20,40)  infectious   317 107294.83
#> 3:              40+  infectious   314  65867.72
```

#### Interpretation

Interpretation Helpers:

+ School closure starting on day 200 for a duration of 250 days can delay the peak of infectious across age groups by 240 days aprox., and reduce the total number of new infections in the whole population by 20,000 aprox.
+ Mask mandate starting on day 200 for a duration of 250 days can delay the peak of infectious across age groups by 40 days aprox., and reduce the total number of new infections in the whole population by 50,000 aprox.
+ Vaccinations starting on day 200 for a duration of 250 days will not delay the peak of infectious across age groups, but reduce the total number of new infections in the whole population by 40,000 aprox. 
    + Note that the effectiveness of vaccination can depend on various factors, including **vaccine efficacy** and **timing relative to the outbreak**.

### Additional challenges

1. **How do the start time and duration of interventions influence the timing and size of the peak in new infections?**
Try modifying the intervention start time from day 200 to day 100, or changing the duration from 250 days to 100 days, and observe the impact on the epidemic dynamics in Zimbabwe.

2. **How can interventions affect the timing and size of the peak in new infections across different countries?** Try changing the population from Zimbabwe to Vietnam or Italy to observe how country-specific factors like population structure and social contacts influence the epidemic curve.

:::



## Activity 3: Combine Multiple Interventions

Compare the baseline scenario with a simulation that includes two overlapping or sequential interventions. Use the intervention parameters described in the previous activity.

**Steps:**  

Open the file `04-practical-activity-3.R` and complete all the lines marked with `#<COMPLETE>`, following the detailed steps provided within the R file.

**Questions:**

Within your room, Write your answers to these questions:

- Interpret: How would you communicate these results to a decision-maker?
- Compare: What differences do you observe compared to the outputs from other rooms (if available)?

### Inputs

| Room | Combine interventions | Compare against |
|---|---|---|
| 1 | School closure AND Vaccine | School closure |
| 2 | Mask mandate AND School contact | Mask mandate |
| 3 | Vaccine AND Mask mandate | Vaccine |



::: {.content-visible when-format="docx"}

### Your Code

Use the file `04-practical-activity-3.R`


### Your Answers

Room 1

| **Output** | **Paste below** |
|---|---|
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* in the whole population, comparing interventions |  |

Write your answers to the questions above:

```







```


------------------------

Room 2

| **Output** | **Paste below** |
|---|---|
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* in the whole population, comparing interventions |  |

Write your answers to the questions above:

```







```


------------------------

Room 3

| **Output** | **Paste below** |
|---|---|
| Table of peaks of *infectious individuals* across age groups |  |
| Plot of *new infections* in the whole population, comparing interventions |  |

Write your answers to the questions above:

```







```

:::






::: {.content-visible unless-format="docx"}

### Solution

<!-- visible for instructors and learners after practical (solutions) -->

#### Outputs


| room 1 | room 2 | room 3 |
| --- | --- | --- |
| ![image](https://hackmd.io/_uploads/Bk_gXjQwex.png) | ![image](https://hackmd.io/_uploads/rylgZiXPeg.png) | ![image](https://hackmd.io/_uploads/S1KyEsXwgg.png) |

room 1

```
epidemics::epidemic_peak(simulate_twointerventions)
#>    demography_group compartment  time    value
#> 1:           [0,20)  infectious   201 7078.228
#> 2:          [20,40)  infectious   261 7677.865
#> 3:              40+  infectious   260 5131.311
```

room 2

```
epidemics::epidemic_peak(simulate_twointerventions)
#>    demography_group compartment  time    value
#> 1:           [0,20)  infectious   648 253705.5
#> 2:          [20,40)  infectious   647 170917.0
#> 3:              40+  infectious   642 100149.4
```

room 3

```
epidemics::epidemic_peak(simulate_twointerventions)
#>    demography_group compartment time    value
#> 1:           [0,20)  infectious  324 29117.39
#> 2:          [20,40)  infectious  324 20627.33
#> 3:              40+  infectious  322 13569.35
```

#### Interpretation

Interpretation Helpers:

+ Overlapping School closure and Vaccinations can have an earlier peak of infectious across age groups by 100 days aprox., and reduce the total number of new infections in the whole population by 75,000 aprox. 
+ Overlapping Mask mandate and School closure can delay the peak of infectious across age groups by 300 days aprox., and reduce the total number of new infections in the whole population by 10,000 aprox. 
+ Overlapping Mask mandate and Vaccination will not change the time of peak of infectious across age groups, but reduce the total number of new infections in the whole population by 70,000 aprox. 

### Additional challenge

1. **What sequence of interventions would you propose to delay the peak and reduce the impact of the epidemic?**
Experiment by independently adjusting the start time and duration of each intervention. Implement them either sequentially or with overlapping periods, and observe their effects on the epidemic dynamics in Zimbabwe. This can support a response plan that allows time for risk assessment and efficient resource allocation.

## Code

### Actiivty 1

```{r, file = "fig/04-practical-instructor-1.R", eval = FALSE}

```

### Actiivty 2

```{r, file = "fig/04-practical-instructor-2.R", eval = FALSE}

```

### Actiivty 3

```{r, file = "fig/04-practical-instructor-3.R", eval = FALSE}

```

# Continue your learning path

<!-- Suggest learners to Epiverse-TRACE documentation or external resources --->

{epidemics} vignette on seasonality and disease-specific model structures (compartments and parameters)

- <https://epiverse-trace.github.io/epidemics/dev/articles/> 

:::

# end