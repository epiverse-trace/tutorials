---
title: 'Read delays'
teaching: 10
exercises: 2
editor_options: 
  chunk_output_type: console
---

:::::::::::::::::::::::::::::::::::::: questions 

- how to get delay distributions from a systematic review?
- what is the natural history of the disease?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Get epidemological parameters from systematic reviews.
- Convert statistical summary to distribution parameters.

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites

This episode requires you to be familiar with:

**Data science** : Basic programming with R.

**Epidemic theory** : Epidemiological parameters. Time periods.

This also requires the following package:

```r
if(!require("pak")) install.packages("pak")
pak::pak("epiverse-trace/epiparameter")
```

:::::::::::::::::::::::::::::::::

## Systematic review of Parameters

The [natural history](../learners/reference.md#naturalhistory) of an infectious disease shows that its development has a regularity from stage to stage. The time periods from a infectious disease inform about the timing of transmission and interventions.

![Definition of key time periods. From [Xiang et al, 2021](https://www.sciencedirect.com/science/article/pii/S2468042721000038)](fig/time-periods.jpg)


::::::::::::::::: callout

### Definitions

Take a look at the [glossary](../learners/reference.md) for the definitions of all the time periods of the figure above!

:::::::::::::::::::::::::

However, early in an epidemic, modelling efforts can be delayed by the lack of a centralized resource that summarized input parameters for the disease of interest ([Nash et al., 2023](https://mrc-ide.github.io/epireview/)). Projects like `{epiparameter}` and `{epireview}` are building online catalogs that can help building models faster for coming outbreaks and epidemics from known and unknown pathogens related to known families of viruses.

<!-- Early models for COVID-19 used parameters from other coronaviruses. -->

Let's explore how we can access to time periods and delays using `{epiparameter}` to plug them in to `{EpiNow2}`. We'll also use the pipe `%>%` to connect some of their functions, so let's also call to the `{tidyverse}` package:

```{r,warning=FALSE,message=FALSE}
library(epiparameter)
library(EpiNow2)
library(tidyverse)
```


## Find a Generation time

The generation time, jointly with the $R$, can inform about the speed of spread and its feasibility of control. Given a $R>1$, with a shorter generation time, cases can appear more quickly.

![From the video by MRC Centre for Global Infectious Disease Analysis, Ep 76. Science In Context - Epi Parameter Review Group with Dr Anne Cori (27-07-2023) at <https://youtu.be/VvpYHhFDIjI?si=XiUyjmSV1gKNdrrL>](fig/reproduction-generation-time.png)

In calculating the effective reproductive number ($R_{t}$), the *generation time* distribution is often approximated by the [serial interval](../learners/reference.md#serialinterval) distribution.
This is because the date of onset of symptoms is more easily observed than the date of onset of infectiousness.

![A schematic of the relationship of different time periods of transmission between an infector and an infectee in a transmission pair. Exposure window is defined as the time interval having viral exposure, and transmission window is defined as the time interval for onward transmission with respect to the infection time ([Chung Lau et al. 2021](https://academic.oup.com/jid/article/224/10/1664/6356465)).](fig/serial-interval-observed.jpeg)

However, this is mostly valid for diseases in which infectiousness starts after symptom onset ([Chung Lau et al. 2021](https://academic.oup.com/jid/article/224/10/1664/6356465)). In cases where infectiousness starts before symptom onset, the serial intervals can be negative, which is the case of a pre-symptomatic transmission ([Nishiura et al. (2020)](https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext#gr2)).

Additionally, even if the *generation time* and *serial interval* have the same mean, their variance usually differ propagating bias to the $R_{t}$ estimation. $R_{t}$ estimates are sensitive not only to the mean generation time but also to the variance and form of the generation interval distribution [(Gostic et al., 2020)](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409).

::::::::::::::::: callout

### From time periods to probability distributions.

When we calculate the *serial interval*, we see that not all case pairs have the same time length. We also observe this variability for individual time periods like the [incubation period](../learners/reference.md#incubation) and [infectious period](../learners/reference.md#infectiousness).

![Serial intervals of possible case pairs in (a) COVID-19 and (b) MERSCoV. Pairs represent a presumed infector and their presumed infectee plotted by date of symptom onset ([Althobaity et al., 2022](https://www.sciencedirect.com/science/article/pii/S2468042722000537#fig6)).](fig/serial-interval-pairs.jpg)

To summarize these data from individual and pair time periods, we can find the **statistical distributions** that best fits to the data ([McFarland et al., 2023](https://www.eurosurveillance.org/content/10.2807/1560-7917.ES.2023.28.27.2200806)).

<!-- add reference about good practices to estimate distributions -->

![Fitted serial interval distribution for (a) COVID-19 and (b) MERS-CoV based on reported transmission pairs in Saudi Arabia. We fitted three commonly used distribution, lognormal, gamma, and Weibull distributions, respectively ([Althobaity et al., 2022](https://www.sciencedirect.com/science/article/pii/S2468042722000537#fig6)).](fig/seria-interval-fitted-distributions.jpg)

Statistical distributions are summarized in terms of their **summary statistics** like the *location* (mean and percentiles) and *spread* (variance or standard deviation) of the distribution, or with their **distribution parameters** that inform about the *form* (shape and rate/scale) of the distribution. Each of these values can be reported with the *uncertainty* (95% confidence intervals) of each estimate.

| Gamma | mean | shape | rate/scale |
|:--------------|:--------------|:--------------|:--------------|
| MERS-CoV | 14.13(13.9–14.7) | 6.31(4.88–8.52) | 0.43(0.33–0.60) |
| COVID-19 | 5.1(5.0–5.5) | 2.77(2.09–3.88) | 0.53(0.38–0.76) |

| Weibull | mean | shape | rate/scale |
|:--------------|:--------------|:--------------|:--------------|
| MERS-CoV | 14.2(13.3–15.2) | 3.07(2.64–3.63) | 16.1(15.0–17.1) |
| COVID-19 | 5.2(4.6–5.9) | 1.74(1.46–2.11) | 5.83(5.08–6.67) |

| Log normal | mean | mean-log | sd-log |
|:--------------|:--------------|:--------------|:--------------|
| MERS-CoV | 14.08(13.1–15.2) | 2.58(2.50–2.68) | 0.44(0.39–0.5) |
| COVID-19 | 5.2(4.2–6.5) | 1.45(1.31–1.61) | 0.63(0.54–0.74) |

Table: Serial interval estimates using gamma, Weibull and log normal distributions. 95% confidence intervals for the shape and scale (logmean and sd for log normal) parameters are shown in brackets ([Althobaity et al., 2022](https://www.sciencedirect.com/science/article/pii/S2468042722000537#fig6)).

<!-- should we keep only one table, the best fit? -->

:::::::::::::::::::::::::

::::::::::::::::::::::::::::::::: challenge

### Serial interval

Let's assume that COVID-19 and SARS has similar Reproduction number values, and the Serial interval a good proxy of the generation interval. 

Given the Serial interval of both infections in the figure below: 

- Which one would be harder to control? 
- Why do you conclude that?

![Serial interval of novel coronavirus (COVID-19) infections overlaid with a published distribution of SARS. From [Nishiura et al, 2020](https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext)](fig/serial-interval-covid-sars.jpg)

::::::::::::::::: hint

The peak of each curve can inform you about the location of the mean of each distribution. The larger the mean, the larger the serial interval. 

::::::::::::::::::::::

::::::::::::::::: solution

Which one would be harder to control?

- COVID-19

Why do you conclude that?

- COVID-19 has the lowest mean serial interval. The approximate mean value for the serial interval of COVID-19 is around 4 days, and SARS is around 7 days. Thus, COVID-19 is likely to have newer generations in less time than SARS, assuming similar reproduction number in both.

::::::::::::::::::::::::::

:::::::::::::::::::::::::::::::::::::::::::

<!-- formative -->
<!-- how to assess on? -->
<!-- compare two scenarios -->
<!-- - high R0 and short generation time -->
<!-- - low R0 and long generation time -->

## Extract epidemiological parameters

Our goal now is to replace the `generation_time` input that we used for `EpiNow2::epinow()`.

```r
epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # distribution
  generation_time = generation_time_opts(generation_time),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)
```

To do this replacement, instead of plug-in numeric values to `EpiNow2::dist_spec()` to manually specify the distribution parameters, we are going to collect them from the library of epidemiological parameters provided by `{epiparameter}`:

```r
generation_time <- dist_spec(
  mean = 3.6,
  sd = 3.1,
  max = 20,
  distribution = "lognormal"
)
```

First, let's assume that the data set `example_confirmed` have COVID-19 observed cases. So, we need to find a reported generation time for COVID-19 or any other useful parameter for this aim. 

Let's start by looking at how many parameters do we have in the epidemiological distributions database (`epidist_db`) for the `disease` named `covid`-19:

```{r}
epiparameter::epidist_db(
  disease = "covid"
)
```

From the `{epiparameter}` package, we can use the `epidist_db()` function to ask for any `disease` and also for an specific epidemiological distribution (`epi_dist`). 

Let's ask now how many parameters do we have in the epidemiological distributions database (`epidist_db`) with the generation time using the string `generation`:

```{r}
epiparameter::epidist_db(
  epi_dist = "generation"
)
```

Currently, in the library of epidemiological parameters we have one `generation` time entry but for Influenza. We can try to look at the `serial` intervals for `COVID`-19.

```{r}
epiparameter::epidist_db(
  disease = "COVID",
  epi_dist = "serial"
)
```

::::::::::::::::: callout

### CASE-INSENSITIVE

`epidist_db` is [case-insensitive](https://dillionmegida.com/p/case-sensitivity-vs-case-insensitivity/#case-insensitivity). This means that you can use strings with letters in upper or lower case indistinctly.

:::::::::::::::::::::::::

We get more than one epidemiological delay. To summarize this view and get the column names from the underlying parameter dataset we can add the previous code the `epiparameter::list_distributions()` function using the pipe `%>%`:

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial"
) %>%
  epiparameter::list_distributions()
```

## Select a single distribution

The `epiparameter::epidist_db()` function works as a filtering or subset function. Let's use the `author` argument to filter `Hiroshi Nishiura` parameters:

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial",
  author = "Hiroshi"
) %>%
  epiparameter::list_distributions()
```

We still get more than one epidemiological parameter. We can set the `single_epidist` argument to `TRUE` to only one:

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial",
  author = "Hiroshi",
  single_epidist = T
)
```

::::::::::::::::: callout

### How does `single_epidist` works?

Take a look into help documentation for `?epiparameter::epidist_db()`.

> Note: If multiple entries match the arguments supplied and `single_epidist = TRUE` then the `⁠<epidist`>⁠ that is parameterised and has the largest sample size will be returned (read `?is_parameterised()`). If multiple entries are equal after this sorting the first entry will be returned.

:::::::::::::::::::::::::

Now we have an epidemiological parameter we can reuse! We can use it to replace the numbers we plug-in to `EpiNow2::dist_spec()`.

Let's do this by assigning this `<epidist>` class object to the `covid_serialint` object.

```{r}
covid_serialint <- 
  epiparameter::epidist_db(
    disease = "covid",
    epi_dist = "serial",
    author = "Nishiura",
    single_epidist = T
  )

covid_serialint
```

::::::::::::::::::::::::::::::::: challenge

### Ebola's incubation period

Take 5 minutes:

- How many delay distributions are for the Ebola disease?

- How many delay distributions are for the incubation period of Ebola?

- What type of distribution has the incubation period of Ebola with highest sample size?

::::::::::::::::: hint

The `{epiparameter}` combo of `epidist_db()` plus `list_distributions()` list all the entries by:
- disease, 
- epidemiological distribution, 
- the type of the probability distribution, 
- author of the study, and 
- year of study.

::::::::::::::::::::::

::::::::::::::::: solution

```{r}
# 16 delays distributions
epiparameter::epidist_db(
  disease = "ebola"
)

# 5 delay distributions are for the incubation period
epiparameter::epidist_db(
  disease = "ebola",
  epi_dist = "incubation"
)

# the distribution with the highest sample size has a gamma distribution
epiparameter::epidist_db(
  disease = "ebola",
  epi_dist = "incubation",
  single_epidist = T
)
```

Now, from the output of `epiparameter::epidist_db()`, What is an [offspring distribution](../learners/reference.md#offspringdist)?

::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::

## Extract the summary statistics

We can get the `mean` and standard deviation (`sd`) from this `<epidist>` diving into the `summary_stats` object:

```{r}
# get the mean 
covid_serialint$summary_stats$mean
```

:::::::::::::::::::::::::::::: challenge

### How to get the `sd` and other nested elements?

Take 1 minute to:

1. Get the `sd` of the epidemiological distribution.

2. Find the `sample_size` used in the study.

3. Explore all the other nested elements within the `<epidist>` object.

Share what is the most interesting element for you!

::::::::: hint

Use the `$` operator plus the <kbd>tab</kbd> keyboard button to explore them as an expandable list:

```r
covid_serialint$
```

Use the `str()` to display the structure of the `<epidist>` R object.

::::::::::::::::::

:::::::::: solution

```{r}
# get the sd 
covid_serialint$summary_stats$sd

# get the sample_size
covid_serialint$metadata$sample_size
```

An interesting element is the `method_assess` nested entry, which refers to the methods used by the study authors to assess for the bias while estimating the serial interval distribution.

```{r}
covid_serialint$method_assess
```

We will explore these concepts at the end!

::::::::::::::::::::

::::::::::::::::::::::::::::::::

## Continuous distributions

The following output has four entries with different content in the probability distribution (`prob_distribution`) column:

```{r}
distribution <- 
  epiparameter::epidist_db(
    disease = "covid",
    epi_dist = "serial"
  )

distribution %>% 
  list_distributions()
```

Entries with a missing value (`<NA>`) in the `prob_distribution` column only posses summary statistics associated with it. Run these commands to find the difference:

```{r,eval=FALSE}
distribution[[1]]$summary_stats
distribution[[1]]$prob_dist
```

As detailed in `?is_parameterised`, a parameterised distribution is the entry that has a probability distribution associated to it provided by an `inference_method` as shown in `metadata`. Run these commands to find the difference:

```{r,eval=FALSE}
distribution[[1]]$metadata$inference_method
distribution[[2]]$metadata$inference_method
distribution[[3]]$metadata$inference_method
distribution[[4]]$metadata$inference_method
```

In the `epiparameter::list_distributions()` output, we can also find different types of probability distributions (e.g., log-normal, weibull, normal).

```{r}
distribution %>% 
  list_distributions()
```

In `{epiparameter}` you will mostly find **continuous** distributions like these. You can visualize any of them with the `plot()` function and access to: 

- the *Probability Density Function (PDF)* and 
- the *Cumulative Distribution Function (CDF)*.

```{r}
plot(distribution[[2]], day_range = 0:20)
```

With the `day_range` argument you can change the length or number of days in the `x` axis.

::::::::::::::::: discussion

### The distribution Zoo

Explore this shinyapp called **The Distribution Zoo**!

Follow these steps to reproduce the `covid_serialint` distribution:

- Access to <https://ben18785.shinyapps.io/distribution-zoo/> shinyapp website!
- Go to the left panel,
- Keep the *Category of distribution*: `Continuous Univariate`,
- Select a new *Distribution type*: `Log-Normal`,
- Move the **sliders**, i.e. the graphical control element that allows you to adjust a value by moving a handle along a track or bar, to the `covid_serialint` parameters. 

<!--
A slider, in the context of user interfaces and graphical user interfaces (GUIs), is a graphical control element that allows users to adjust a value by moving a handle along a track or bar. Conceptually, it provides a way to select a numeric value within a specified range by visually sliding or dragging a pointer (the handle) along a continuous axis.
-->

Replicate these with the `distribution` object and all its list elements: `2`, `3`, and `4`. Explore:

- How does the shape of a distribution change when its parameters change?

Share what other useful features you find in the website.

:::::::::::::::::::::::::

## Distribution functions

In R, all the statistical distributions has functions to access to:

- density,
- cumulative distribution function,
- quantile function, and
- random variate generation.

:::::::::::: spoiler

### Functions for the Normal distribution

If you needed it, read in detail about the [R probability functions for the normal distribution](https://sakai.unc.edu/access/content/group/3d1eb92e-7848-4f55-90c3-7c72a54e7e43/public/docs/lectures/lecture13.htm#probfunc), each of its definitions and identify in which part of a distribution they are located!

![The four probability functions for the normal distribution ([Jack Weiss, 2012](https://sakai.unc.edu/access/content/group/3d1eb92e-7848-4f55-90c3-7c72a54e7e43/public/docs/lectures/lecture13.htm#probfunc))](fig/fig5a-normaldistribution.png)

::::::::::::::::::::

If you look at `?stats::Distributions`, each type of distribution has a unique set functions. However, `{epiparameter}` allows gives you one same set of four functions to access to each of the values above for any `<epidist>` object you want! 

```{r,eval=FALSE}
# plot this to have a visual reference
plot(covid_serialint, day_range = 0:20)
```

```{r}
# the density value at quantile value of 10 (days)
density(covid_serialint, at = 10)

# the cumulative probability at quantile value of 10 (days)
cdf(covid_serialint, q = 10)

# the quantile value (day) at a cumulative probability of 60%
quantile(covid_serialint, p = 0.6)

# generate 10 random values (days) given the distribution family and its parameters
generate(covid_serialint, times = 10)
```

::::::::: instructor

Access to the reference documentation (Help files) for these functions is accessible with the three double-colon notation: `epiparameter:::`

```{r}
?epiparameter:::density.epidist()
?epiparameter:::cdf.epidist()
?epiparameter:::quantile.epidist()
?epiparameter:::generate.epidist()
```

::::::::::::::::::

::::::::::::::::::::::::::::::::: challenge

### 99th percentile of the serial interval?

When considering secondary cases, after how many days following the symptom onset of primary cases can we expect 99% of symptom onset to occur?

::::::::::::::::: hint

In Figure 5 from the [R probability functions for the normal distribution](https://sakai.unc.edu/access/content/group/3d1eb92e-7848-4f55-90c3-7c72a54e7e43/public/docs/lectures/lecture13.htm#probfunc), the shadowed section represents a cumulative probability of `0.997` for the quantile value at `x = 2`.

::::::::::::::::::::::

::::::::::::::::: solution

```{r}
quantile(covid_serialint, p = 0.99)
```

The 99% percent of the symptom onset of secondary cases will happen after 14.99 days after the symptom onset of primary cases.

_Does this result make sense or is expected?_

::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::


## Discretize a continuous distribution

We are almost halfway! `EpiNow2::dist_spec()` still needs a maximum value (`max`). 

One way to do this is getting the quantile value for the the 99.9th percentile or `0.999` cumulative probability of the distribution. For this we need to access to the set of distribution functions for our `<epidist>` object.

We can use the set of distribution functions for a _continuous_ distribution (as above). However, this values will be _continuous_ numbers. To get discrete values from a continuous distribution we can **discretize** the continuous distribution stored in our `<epidist>` object.

When we `epiparameter::discretise()` the continuous distribution we get a **discrete**(-ized) distribution:

```{r}
covid_serialint_discrete <- epiparameter::discretise(covid_serialint)

covid_serialint_discrete
```

We identify this change in the `Distribution:` output line of the `<epidist>` object. Take a double check to this line:

```
Distribution: discrete lnorm
```

For a **continuous** distribution, we plot the *Probability Density Function (PDF)*:

```{r,eval=FALSE}
plot(covid_serialint)
```

For a **discrete** distribution, we plot the *Probability Mass Function (PMF)*:

```{r}
plot(covid_serialint_discrete)
```

To finally get a `max` value let's access to the quantile value of the 99.9th percentile or `0.999` probability of the distribution with the `prob_dist$q` notation, similarly to how we access to the `summary_stats` values.

```{r}
covid_serialint_discrete_max <- covid_serialint_discrete$prob_dist$q(p = 0.999)
```

::::::::::::::::::::::::::::::::: challenge

### 99th percentile of the incubation period of COVID-19

Within what time frame do 99% of individuals who develop COVID-19 symptoms exhibit them after infection?

::::::::::::::::: hint

First, we are asking about a different distribution delay: incubation period 

Probability function for `<epidist>` **discrete** distributions differ from the *continuous* ones!

```{r,eval=FALSE}
# plot to have a visual reference
plot(covid_serialint_discrete, day_range = 0:20)

# density value at quantile value 10 (day)
covid_serialint_discrete$prob_dist$d(10)

# cumulative probability at quantile value 10 (day)
covid_serialint_discrete$prob_dist$cdf(10)

# in what quantile value (days) we have the 60% cumulative probability?
covid_serialint_discrete$prob_dist$q(0.6)
# covid_serialint_discrete$prob_dist$qf(0.6) # as in continuous distribution

# generate random values
covid_serialint_discrete$prob_dist$r(10)

# create a discrete distribution visualization
x_limit <- covid_serialint_discrete$prob_dist$q(0.999)

tibble(
  # generate quantile values as a sequence for each natural number
  quantile_values = seq(1L, to = x_limit, by = 1L)
) %>% 
  mutate(
    # calculate the values for each quantiles in the density function
    density_values = covid_serialint_discrete$prob_dist$d(quantile_values)
  ) %>%
  ggplot(aes(
    x = quantile_values,
    y = density_values)
  ) +
  geom_col()
```

::::::::::::::::::::::

::::::::::::::::: solution

```{r}
covid_incubation <- 
  epiparameter::epidist_db(
    disease = "covid",
    epi_dist = "incubation",
    single_epidist = T
  )

covid_incubation_discrete <- epiparameter::discretise(covid_incubation)

covid_incubation_discrete$prob_dist$q(0.99)
```

99% of those who develop COVID-19 symptoms will do so within 16 days of infection.

_Dive into the structure of this new `<epidist>` R object for discrete distributions!_

::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::

## Plug-in `{epiparameter}` to `{EpiNow2}`

Now we are ready to plug-in all to the `EpiNow2::dist_spec()` function!

```{r}
serial_interval_covid <- 
  dist_spec(
    mean = covid_serialint$summary_stats$mean,
    sd = covid_serialint$summary_stats$sd,
    max = covid_serialint_discrete_max,
    distribution = "lognormal"
  )

serial_interval_covid
```

:::::::::: callout

### Warning

Using the serial interval instead of the generation time is an alternative that can propagate bias in your estimates. Even more in diseases with reported pre-symptomatic transmission!

::::::::::::::::::

Now, let's replace the `generation_time` input that we used for `EpiNow2::epinow()`.

```{r,eval=FALSE}
epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # delays
  generation_time = generation_time_opts(serial_interval_covid),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)

base::plot(epinow_estimates)
```

::::::::::::::::::::::::::::::::: challenge

### EBOLA

Download the [Ebola dataset](data/ebola_cases.csv):

- Reuse one epidemiological parameter to estimate the effective reproductive number for the Ebola dataset.

```{r,eval=FALSE}
ebola_confirmed <- read_csv("data/raw-data/ebola_cases.csv")
```

::::::::::::::::: hint

Key functions we applied until now:

- `epidist_db`
- `list_distributions`
- `discretise`
- probability functions 

Review the type of distribution of the parameter you choose.

::::::::::::::::::::::

::::::::::::::::: solution

```{r,eval=FALSE}
# read data from tutorial repository R project
ebola_confirmed <- read_csv("episodes/data/ebola_cases.csv")
```

```{r,message=FALSE,warning=FALSE,eval=FALSE}
# read data
ebola_confirmed <- read_csv("data/raw-data/ebola_cases.csv")

# list distributions
epidist_db(disease = "ebola") %>% 
  list_distributions()

# subset one distribution 
ebola_serial <- epidist_db(disease = "ebola", epi_dist = "serial", single_epidist = T)

ebola_serial_discrete <- discretise(ebola_serial)

serial_interval_ebola <- 
  dist_spec(
    mean = ebola_serial$summary_stats$mean,
    sd = ebola_serial$summary_stats$sd,
    max = ebola_serial_discrete$prob_dist$q(p = 0.999),
    distribution = "gamma"
  )

epinow_estimates <- epinow(
  # cases
  reported_cases = ebola_confirmed,
  # distribution
  generation_time = generation_time_opts(serial_interval_ebola),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)

plot(epinow_estimates)

```

::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::  


## Add the Incubation period

For `{EpiNow2}`, we can specify relevant delay distributions like the [incubation period](../learners/reference.md#incubation).

The lengths of the Serial interval and Incubation period determine the type of transmission of a disease.

![The relationship between the incubation period and serial interval. From [Nishiura 2020](https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext)](fig/incubation-period-serial-interval.jpg)

The proportion of pre-symptomatic transmission contributes to the effective reproductive number and expected new cases to have.

![Parameter estimates. Plausible ranges for the key parameters R0 and θ (read main text for sources) for four viral infections of public concern are shown as shaded regions. The size of the shaded area reflects the uncertainties in the parameter estimates. [Fraser et al., 2004](https://www.pnas.org/doi/10.1073/pnas.0307506101)](fig/reproduction-number-pre-symptomatic.png)

::::::::::::::::::::::::::::::::: challenge

### WHAT TYPE OF TRANSMISSION?

Compare the serial interval and incubation period of Influenza and MERS:

- What type of transmission have Influenza?
- What type of transmission have MERS?
- Does these results correlates with the available evidence?

::::::::::::::::: hint

Key functions:

- `epidist_db()`
- `epidist$summary_stats$`

::::::::::::::::::::::

::::::::::::::::: solution

```{r}
# pre-symptomatic transmission
epidist_db(disease = "influenza",epi_dist = "incubation",single_epidist = T)$summary_stats$mean
epidist_db(disease = "influenza",epi_dist = "serial",single_epidist = T)$summary_stats$mean

# symptomatic transmission
epidist_db(disease = "mers",epi_dist = "incubation",single_epidist = T)$summary_stats$median
epidist_db(disease = "mers",epi_dist = "serial",single_epidist = T)$summary_stats$mean
```

```{r,eval=FALSE}
# pre-symptomatic transmission
epidist_db(disease = "covid",epi_dist = "incubation",author = "Stephen",single_epidist = T)$summary_stats$mean
epidist_db(disease = "covid",epi_dist = "serial",author = "Nishiura",single_epidist = T)$summary_stats$mean

# symptomatic transmission
epidist_db(disease = "ebola",epi_dist = "incubation",single_epidist = T)$summary_stats$mean
epidist_db(disease = "ebola",epi_dist = "serial",single_epidist = T)$summary_stats$mean
```


::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::


<!-- fix with screenshot from larger computer monitor -->

<!-- Transmission before symptoms -->
<!-- https://www.thelancet.com/article/S2214-109X(20)30074-7/fulltext -->

<!-- The highest the Reproduction number, more -->
<!-- Required coverage ~duration~ of contact tracing -->
<!-- https://www.thelancet.com/article/S2214-109X(20)30074-7/fulltext -->
<!-- https://royalsocietypublishing.org/doi/10.1098/rstb.2016.0371 -->

::::::::::::::::::::::::::::::::: challenge

### Reuse an Incubation period for COVID-19

Use `{epiparameter}` to:

- Find and incubation period for COVID-19
- Add to our last `epinow()` code chunk the `incubation_time_covid` in the `delays` argument.

::::::::::::::::: hint

```r
epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # generation time
  generation_time = generation_time_opts(serial_interval_covid),
  # delays
  delays = delay_opts(incubation_time_covid),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)
```

::::::::::::::::::::::

::::::::::::::::: solution

```{r,eval=FALSE}
covid_incubation <- epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "incubation",
  author = "Natalie",
  single_epidist = T
)

covid_incubation

covid_incubation_discrete <- epiparameter::discretise(covid_incubation)

incubation_time_covid <- dist_spec(
  mean = covid_incubation$summary_stats$mean,
  sd = covid_incubation$summary_stats$sd,
  max = covid_serialint_discrete$prob_dist$q(p = 0.999),
  distribution = "lognormal"
)

epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # generation time
  generation_time = generation_time_opts(serial_interval_covid),
  # delays
  delays = delay_opts(incubation_time_covid),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)

base::plot(epinow_estimates)
```

::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::


:::::::::::::: discussion

### How much it changed?

After adding the incubation period, discuss:

- Does the retrospective trend of forecast changed?
- Does the uncertainty changed?

::::::::::::::::::::::::::::

## Extract parameters

<!-- https://github.com/epiverse-trace/epiparameter/issues/114 -->


### formative

```{r,eval=FALSE}
# what parameters are are available for influenza?
epidist_db(disease = "influenza") %>% 
  list_distributions() %>% 
  as_tibble() %>% 
  count(epi_distribution)

influenza_generation <- epidist_db(disease = "influenza",epi_dist = "generation")

influenza_generation_discrete <- discretise(influenza_generation)

influenza_generation$summary_stats$median
influenza_generation$summary_stats$quantiles

# question: is dispersion valid for quantiles?
# convert_summary_stats_to_params(
#   distribution = "lnorm", 
#   median = influenza_generation$summary_stats$median,
#   quantiles = influenza_generation$summary_stats$quantiles)

influenza_extracted <- extract_param(
  type = "percentiles",
  values = c(influenza_generation$summary_stats$quantiles[1],
             influenza_generation$summary_stats$quantiles[2]),
  distribution = "lnorm",
  percentiles = c(0.05,0.95)
)

generation_time_influenza <- 
  dist_spec(
    mean = influenza_extracted[1],
    sd = influenza_extracted[2],
    max = influenza_generation_discrete$prob_dist$q(p = 0.999),
    distribution = "lognormal"
  )

influenza_cleaned <- outbreaks::influenza_england_1978_school %>% 
  select(date,confirm = in_bed)

epinow_estimates <- epinow(
  # cases
  reported_cases = influenza_cleaned,
  # distribution
  generation_time = generation_time_opts(generation_time_influenza),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)

plot(epinow_estimates)
```

### formative

```{r}
# formative, now with ebola -----------------------------------------------

# read ebola


```

However, this still propagates potential biases like

- censoring bias (short periods)
- reporting bias (recent contacts)

## Add the Reporting delays

Estimating Rt requires data on the daily number of new infections (i.e., transmission events). Due to lags in the development of detectable viral loads, symptom onset, seeking care, and reporting, these numbers are not readily available. All observations reflect transmission events from some time in the past. In other words, if d is the delay from infection to observation, then observations at time t inform Rt−d, not Rt. [(Gostic et al., 2020)](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409#sec007)

![Rt is a measure of transmission at time t. Observations after time t must be adjusted. ICU, intensive care unit. From  [Gostic et al., 2020](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409#sec007)](fig/rt-adjusting-delays.png)

We can opt to adjust `{EpiNow2}` outputs by the [reporting delay](../learners/reference.md#reportingdelay) that condition the report of confirmed cases.

![Timeline for chain of disease reporting, the Netherlands. Lab, laboratory; PHA, public health authority. From [Marinović et al., 2015](https://wwwnc.cdc.gov/eid/article/21/2/13-0504_article)](fig/disease-reporting.jpg)

### any epiparameter?

```{r}
epidist_db(disease = "all") %>% list_distributions() %>% 
  as_tibble() %>% 
  distinct(epi_distribution)
```

### replace in epinow2

```{r}

```

### epinow2

```{r,message=FALSE,warning=FALSE,cache=TRUE,eval=FALSE}
reporting_delay <- dist_spec(
  mean = convert_to_logmean(2, 1), 
  sd = convert_to_logsd(2, 1),
  max = 10, distribution = "lognormal"
)

epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # delays
  generation_time = generation_time_opts(generation_time),
  delays = delay_opts(
    incubation_period + reporting_delay
  ),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)
```

## Severity parameters

The three examples above represent transmission parameters.

One example of severity parameter is the duration of hospitalization (bed capacity needed)

### explore

```{r}
epidist_db(disease = "all") %>% list_distributions() %>% 
  as_tibble() %>% 
  distinct(epi_distribution)
```

## From our data! (callout)

- How to get serial interval from case data? <!-- possibly in a separate episode? -->
- how long should contacts be followed?
- what is the required duration of contact tracing?
- how long should cases be isolated to reduce transmission?

An interesting example is the `method_assess` nested entry, which refers to the methods used to assess for the bias while estimating the serial interval distribution.

```{r}
covid_serialint$method_assess
```

Fit a parametric distribution to estimate the mean and sd

estimate serial interval from case and contact data pairs 

<!-- ref: https://www.reconlearn.org/post/real-time-response-2 -->

ref: https://epiverse-trace.github.io/epimodelac/EnfermedadX.html

Recall that "Methods for accurate estimation of the generation interval from contact tracing data involve adjusting for right truncation and accounting for population susceptibility at the times transmission pairs are observed" [(Gostic et al., 2020)](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409)

<!--
## Concept map

update it from last epiparameter test 
-->

::::::::::::::::::::::::::::::::::::: keypoints 

- Use `{epiparameter}`

::::::::::::::::::::::::::::::::::::::::::::::::

