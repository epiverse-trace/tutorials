---
title: 'Describe case data'
teaching: 10
exercises: 2
editor_options: 
  chunk_output_type: console
---

:::::::::::::::::::::::::::::::::::::: questions 

- how to obtain delay distributions from a literature systematic review?
- what is the natural history of the disease?
- how long should contacts be followed?
- what is the required duration of contact tracing?
- how long should cases be isolated to reduce transmission?

- what are the epidemiological characteristics of the infection?
- what is the demographic distribution of cases?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Get epidemological parameters from systematic reviews.
- Convert statistical summary to distribution parameters.

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites

This episode requires you to be familiar with:

**Data science** : Basic programming with R.

**Epidemic theory** : Epidemiological parameters. Time periods.

This also requires the following package:

```r
if(!require("pak")) install.packages("pak")
pak::pak("epiverse-trace/epiparameter")
```

:::::::::::::::::::::::::::::::::

## Systematic review of Parameters

The [natural history](../learners/reference.md#naturalhistory) of a infectious disease shows that its development has a regularity from stage to stage. The time periods from a infectious disease inform about the timing of transmission and interventions.

![Definition of key time periods. From [Xiang et al, 2021](https://www.sciencedirect.com/science/article/pii/S2468042721000038)](fig/time-periods.jpg)


::::::::::::::::: callout

### Definitions

Take a look at the [glossary](../learners/reference.md) for the definitions of all the time periods of the figure above!

:::::::::::::::::::::::::

However, early in an epidemic, modelling efforts can be delayed by the lack of a centralized resource that summarized input parameters for the disease of interest ([Nash et al., 2023](https://mrc-ide.github.io/epireview/)). Projects like `{epiparameter}` and `{epireview}` are building online catalogs that can help building models faster for coming outbreaks and epidemics from known and unknown pathogens related to known families of viruses.

<!-- Early models for COVID-19 used parameters from other coronaviruses. -->

Let's explore how we can access to time periods and delays using `{epiparameter}` to plug them in to `{EpiNow2}`:

```{r}
library(epiparameter)
library(EpiNow2)
library(tidyverse)
```


## Find a generation time

The generation time, jointly with the $R$, can inform about the speed of spread and its feasibility of control. Given a $R>1$, with a shorter generation time, cases can appear more quickly.

![From the video by MRC Centre for Global Infectious Disease Analysis, Ep 76. Science In Context - Epi Parameter Review Group with Dr Anne Cori (27-07-2023) at <https://youtu.be/VvpYHhFDIjI?si=XiUyjmSV1gKNdrrL>](fig/reproduction-generation-time.png)

In calculating the effective reproductive number ($Rt$), the generation time distribution is often approximated by the [serial interval](../learners/reference.md#serialinterval) distribution.
This is because the date of onset of symptoms is more easily observed than the date of onset of infectiousness.

<!-- This can produced biased estimates. ([Knight et al., 2020](https://www.sciencedirect.com/science/article/pii/S2468042720300634?via%3Dihub)) -->

However, this is valid for diseases in which infectiousness starts after symptom onset [(Chung Lau et al. 2021)](https://academic.oup.com/jid/article/224/10/1664/6356465). In cases where infectiousness starts before symptom onset serial intervals can be negative! This is the case of a pre-symptomatic transmission.

Even if the generation time and serial interval have the same mean, their variance usually differ propagating bias to the Rt estimation. Rt estimates are sensitive not only to the mean generation time but also to the variance and form of the generation interval distribution [(Gostic et al., 2020)](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409).

<!-- formative -->
<!-- how to assess on? -->
<!-- compare two scenarios -->
<!-- - high R0 and short generation time -->
<!-- - low R0 and long generation time -->

::::::::::::::::::::::::::::::::: challenge

### REVIEW

Let's assume that COVID-19 and SARS has similar Reproduction number values, and the Serial interval a good proxy of the generation interval. 

Given the Serial interval of both infections in the figure below: 

- Which one would be harder to control? 
- Why do you conclude that?

![Serial interval of novel coronavirus (COVID-19) infections overlaid with a published distribution of SARS. From [Nishiura et al, 2020](https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext)](fig/serial-interval-covid-sars.jpg)

::::::::::::::::: hint

### HINT

The peak of each curve can inform you about the location of the mean of each distribution. The larger the mean, the larger the serial interval. 

::::::::::::::::::::::

::::::::::::::::: solution

### SOLUTION

Which one would be harder to control?

- COVID-19

Why do you conclude that?

- COVID-19 has the lowest mean serial interval. The approximate mean value for the serial interval of COVID-19 is around 4 days, and SARS is around 7 days. Thus, COVID-19 is likely to have newer generations in less time than SARS, assuming similar reproduction number in both.

::::::::::::::::::::::::::


:::::::::::::::::::::::::::::::::::::::::::

## Extract epidemiological parameters

Our goal now is to replace the `generation_time` input that we used for `EpiNow2::epinow()`.

```r
epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # distribution
  generation_time = generation_time_opts(generation_time),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)
```

To do this replacement, instead of plug-in numeric values to `EpiNow2::dist_spec()` to manually specify the distribution parameters, we are going to collect them from the library of epidemiological parameters provided by `{epiparameter}`:

```r
generation_time <- dist_spec(
  mean = 3.6,
  sd = 3.1,
  max = 20,
  distribution = "lognormal"
)
```

First, let's assume that the data set `example_confirmed` have COVID-19 observed cases. So, we need to find a reported generation time for COVID-19 or any other useful parameter for this aim.

From the `{epiparameter}` package, we can use the `epidist_db()` function to ask for any epidemiological distribution (`epi_dist`) with the generation time using the string `generation`:

```{r}
epiparameter::epidist_db(
  epi_dist = "generation"
)
```

Currently, in the library of epidemiological parameters we do not have  `generation` time entry for COVID-19. We can try to look at the `serial` intervals for COVID-19.

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial"
)
```

::::::::::::::::: callout

`epidist_db` is not case-sensitive. This means that you can use strings with upper and lower case indistinctly.

:::::::::::::::::::::::::

We get more than one epidemiological delay. To summarize this view and get the column names from the underlying parameter dataset we can add the previous code the `epiparameter::list_distributions()` function using the pipe `%>%`:

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial") %>%
  epiparameter::list_distributions()
```

The `epiparameter::epidist_db()` function works as a filtering or subset function. Let's use the `author` argument to filter `Hiroshi Nishiura` parameters:

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial",
  author = "Hiroshi") %>%
  epiparameter::list_distributions()
```

We still get more than one epidemiological parameter. We can set the `single_epidist` argument to `TRUE` to only one:

```{r}
epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial",
  author = "Hiroshi",
  single_epidist = T)
```

::::::::::::::::: callout

### How does `single_epidist` works?

Take a look into help documentation for `?epiparameter::epidist_db()`.

> Note: If multiple entries match the arguments supplied and single_epidist = TRUE then the `⁠<epidist`>⁠ that is parameterised and has the largest sample size will be returned (see `?is_parameterised()`). If multiple entries are equal after this sorting the first entry will be returned.

:::::::::::::::::::::::::

Now we have our epidemiological parameter of interest! We can use it to replace the number we plug-in to `EpiNow2::dist_spec()`

Let's do this by assigning this `epidist` class object to the `covid_lnorm` object.

```{r}
covid_lnorm <- epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "serial",
  author = "Nishiura",
  single_epidist = T) # not desired

covid_lnorm
```

## Extract the summary statistics

We can get the `mean` and standard deviation (`sd`) from this `epidist` diving into the `summary_stats` object:

```{r}
# get the mean 
covid_lnorm$summary_stats$mean
```

:::::::::::::::::::::::::::::: challenge

## How to get the `sd` and other nested elements?

Take 1 minute to:

- Get the `sd` from the `epidist` object.

- Explore all the other nested elements within the `epidist` object.

Share what is the most interesting element for you!

::::::::: hint

Using the `$` operator plus the `TAB` keyboard button to explore them as an expandable list:

```r
covid_lnorm$
```

::::::::::::::::::

:::::::::: solution

```{r}
# get the sd 
covid_lnorm$summary_stats$sd
```

An interesting element is the `method_assess` nested entry, which refers to the methods used by the study authora to assess for the bias while estimating the serial interval distribution.

```{r}
covid_lnorm$method_assess
```

We will explore this at the end!

::::::::::::::::::::

::::::::::::::::::::::::::::::::

## Discretize a continuous distribution

We are almost halfway! `EpiNow2::dist_spec()` still needs a maximum value (`max`). 

One way to do this is getting the quantile value for the the 99.9% or `0.999` cumulative probability of the distribution. For this we need to access to the set of distribution functions for our `epidist` object.

To achieve this we can **discretize** the continuous distribution stored in our `epidist` object.

The epidemiological parameter stored in `covid_lnorm` is a **continuous** distribution. Here we plot its *Probability Density Function (PDF)*:

```{r}
plot(covid_lnorm)
```

When we `epiparameter::discretise()` the continuous distribution we get a **discrete** distribution:

```{r}
covid_lnorm_discrete <- epiparameter::discretise(covid_lnorm)

covid_lnorm_discrete
```

We identify this change in the `Distribution:` output line of the `epidist` object. Take a double check to this line:

```
Distribution: discrete lnorm
```

For a **discrete** distribution, we plot the *Probability Mass Function (PMF)*:

```{r}
plot(covid_lnorm_discrete)
```

To finally get a `max` value let's access to the quantile value of the 99% or `0.999` probability of the distribution with the `prob_dist$q` notation, similarly to how we access to the `summary_stats` values.

```{r}
covid_lnorm_discrete_max <- covid_lnorm_discrete$prob_dist$q(p = 0.999)
```

Now we are ready to plug-in all to the `EpiNow2::dist_spec()` function!

```{r}
generation_time_epiparam <- dist_spec(
  mean = covid_lnorm$summary_stats$mean,
  sd = covid_lnorm$summary_stats$sd,
  max = covid_lnorm_discrete_max,
  distribution = "lognormal"
)

epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # delays
  generation_time = generation_time_opts(generation_time_epiparam),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)

base::plot(epinow_estimates)
```

## formative

```{r}
# what parameters are are available for influenza?
epidist_db(disease = "influenza") %>% 
  list_distributions() %>% 
  as_tibble() %>% 
  count(epi_distribution)
```


```{r}
# generation time for ebola
# if not, find serial interval and use it as serial interval
```

## Find the incubation time

What it is?
With which other is related?

The natural history of a disease influence the transmission dynamics. For `{EpiNow2}`, we can specify relevant delay distributions like the [incubation period](../learners/reference.md#incubation):

![The relationship between the incubation period and serial interval. From [Nishiura 2020](https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext)](fig/incubation-period-serial-interval.jpg)

![Parameter estimates. Plausible ranges for the key parameters R0 and θ (see main text for sources) for four viral infections of public concern are shown as shaded regions. The size of the shaded area reflects the uncertainties in the parameter estimates. [Fraser et al., 2004](https://www.pnas.org/doi/10.1073/pnas.0307506101)](fig/reproduction-number-pre-symptomatic.png)
<!-- fix with screenshot from larger computer monitor -->

<!-- Transmission before symptoms -->
<!-- https://www.thelancet.com/article/S2214-109X(20)30074-7/fulltext -->

<!-- The highest the Reproduction number, more -->
<!-- Required coverage ~duration~ of contact tracing -->
<!-- https://www.thelancet.com/article/S2214-109X(20)30074-7/fulltext -->
<!-- https://royalsocietypublishing.org/doi/10.1098/rstb.2016.0371 -->

```{r}
incubation_period <- dist_spec(
  mean = 4, sd = 2,
  max = 20, distribution = "gamma"
)
```

```{r,message=FALSE,warning=FALSE,cache=TRUE}
epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # delays
  generation_time = generation_time_opts(generation_time),
  delays = delay_opts(incubation_period),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)
```


```{r}
### 2 include incubation time ------

epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "incubation") %>%
  epiparameter::list_distributions()

covid_incubation <- epiparameter::epidist_db(
  disease = "covid",
  epi_dist = "incubation",
  author = "Natalie",
  single_epidist = T
)

covid_incubation

covid_incubation$summary_stats$mean
covid_incubation_discrete <- epiparameter::discretise(covid_incubation)
covid_incubation_discrete_max <- covid_lnorm_discrete$prob_dist$q(p = 0.999)

incubation_time_epiparam <- dist_spec(
  mean = covid_incubation$summary_stats$mean,
  sd = covid_incubation$summary_stats$sd,
  max = covid_incubation_discrete_max,
  distribution = "lognormal"
)

epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # generation time
  generation_time = generation_time_opts(generation_time_epiparam),
  # delays
  delays = delay_opts(incubation_time_epiparam),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)

base::plot(epinow_estimates)

# post calculation questions
# what have changed?
# - cases by date of infection
# - uncertainty

```

## formative

```{r}
# formative, now with ebola -----------------------------------------------

# read ebola


```

Potential biases like

- censoring bias (short periods)
- reporting bias (recent contacts)

## Find the reporting delay

What it is?
With which other is related?

Adjusting for delays

![Rt is a measure of transmission at time t. Observations after time t must be adjusted. ICU, intensive care unit. From  [Gostic et al., 2020](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409#sec007)](fig/rt-adjusting-delays.png)

The natural history of a disease influence the transmission dynamics. For `{EpiNow2}`, we can specify relevant delay distributions like the [reporting delay](../learners/reference.md#reportingdelay):

![Timeline for chain of disease reporting, the Netherlands. Lab, laboratory; PHA, public health authority. From [Marinović et al., 2015](https://wwwnc.cdc.gov/eid/article/21/2/13-0504_article)](fig/disease-reporting.jpg)

```{r}
reporting_delay <- dist_spec(
  mean = convert_to_logmean(2, 1), 
  sd = convert_to_logsd(2, 1),
  max = 10, distribution = "lognormal"
)
```

```{r,message=FALSE,warning=FALSE,cache=TRUE}
epinow_estimates <- epinow(
  # cases
  reported_cases = example_confirmed[1:60],
  # delays
  generation_time = generation_time_opts(generation_time),
  delays = delay_opts(
    incubation_period + reporting_delay
  ),
  # computation
  stan = stan_opts(
    cores = 4, samples = 1000, chains = 3,
    control = list(adapt_delta = 0.99)
  )
)
```

## formative

```{r}
### 3 add reporting delay --------

# now is your turn!
# after the ebola assessment


```

## Severity parameters

The three examples above represent transmission parameters.

- Duration of hospitalization (bed capacity needed)

## From our data! (callout)

An interesting example is the `method_assess` nested entry, which refers to the methods used to assess for the bias while estimating the serial interval distribution.

```{r}
covid_lnorm$method_assess
```


Fit a parametric distribution to estimate the mean and sd

estimate serial interval from case and contact data pairs 

ref: https://www.reconlearn.org/post/real-time-response-2

ref: https://epiverse-trace.github.io/epimodelac/EnfermedadX.html

Recall that "Methods for accurate estimation of the generation interval from contact tracing data involve adjusting for right truncation and accounting for population susceptibility at the times transmission pairs are observed" [(Gostic et al., 2020)](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008409)

## Convert from statistical summaries to distribution parameters

...

## concept map

update it from last epiparameter test 

::::::::::::::::::::::::::::::::::::: keypoints 

- Use `{epiparameter}`

::::::::::::::::::::::::::::::::::::::::::::::::

