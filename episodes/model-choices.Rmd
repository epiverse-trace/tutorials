---
title: 'Choosing an appropriate model'
teaching: 10 # teaching time in minutes
exercises: 20 # exercise time in minutes

---

```{r setup, echo= FALSE, message = FALSE, warning = FALSE}
require(ggplot2)
require(pak)
require(tidyverse)
pak::pak("epiverse-trace/epidemics")
library(epidemics)
```


:::::::::::::::::::::::::::::::::::::: questions 

- How do I choose a model for my task?


::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Learn how to access the model library in `epidemics`
- Understand the model requirements for a question 

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites
+ Complete tutorial [Simulating transmission](../episodes/simulating-transmission.md)
:::::::::::::::::::::::::::::::::


## Introduction

Using mathematical models in outbreak analysis does not necessarily require developing a new model. There are existing models for different infections, interventions and transmission patterns which can be used to answer new questions. In this tutorial, we will learn how to choose an existing model to generate predictions for a given scenario.

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

The focus of this tutorial is understanding existing models to decide if they are appropriate for a defined question. 

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

### Choosing a model 

When deciding whether an existing model can be used, we must consider :

+ What is the infection/disease of interest? 

A model may already exist for your study disease, or there may be a model for an infection that has the same transmission pathways and epidemiological features that can be used. 

+ Do we need a [deterministic](../learners/reference.md#deterministic) or [stochastic](../learners/reference.md#stochastic) model? 

Model structures differ for whether the disease has pandemic potential or not. When predicted numbers of infection are small, stochastic variation in output can have an effect on whether an outbreak takes off or not. Outbreaks are usually smaller in magnitude than epidemics, so its often appropriate to use a stochastic model to characterise the uncertainty in the early stages of the outbreak. Epidemics are larger in magnitude than outbreaks and so a deterministic model is suitable as we have less interest in the stochastic variation in output. 

+ What is the outcome of interest?

The outcome of interest can be a feature of a mathematical model. It may be that you are interested in the predicted numbers of infection through time, or in a specific outcome such as hospitalisations or cases of severe disease.

+ Will any interventions be modelled? 

Finally, interventions such as vaccination may be of interest. A model may or may not have the capability to include the impact of different interventions on different time scales (continuous time or at discrete time points). We will discuss interventions in detail in the next tutorial.

### Available  models
 
The R package `epidemics` contains functions to run existing models.
For details on the models that are available, see the package [vignettes](https://epiverse-trace.github.io/epidemics/articles). To learn how to run the models in R, read the documentation using `?epidemics::model_ebola_r`. Remember to use the questions in the '[Check model equation](#check-model-equations)' checklist to help your understanding of an  existing model. 

::::::::::::::::::::::::::::::::::::: checklist
### Check model equations

- How is transmission modelled? e.g. direct or indirect, airborne or vector-borne
- What interventions are modelled? 
- What state variables are there and how do they relate to assumptions about infection?

::::::::::::::::::::::::::::::::::::::::::::::::



## Challenge : Ebola outbreak analysis 

::::::::::::::::::::::::::::::::::::: challenge

## What model?

You have been asked to explore the variation in numbers of infectious individuals in the early stages of an Ebola outbreak. 

Which of the following models would be an appropriate choice for this task:

+  `model_default_cpp()`

+ `model_ebola_r()`

::::::::::::::::: hint

### HINT

Consider the following questions:

::::::::::::::::::::::::::::::::::::: checklist

+ What is the infection/disease of interest? 
+ Do we need a deterministic or stochastic model? 
+ What is the outcome of interest?
+ Will any interventions be modelled? 

::::::::::::::::::::::::::::::::::::::::::::::::


::::::::::::::::::::::


::::::::::::::::: solution

### SOLUTION


+ What is the infection/disease of interest? **Ebola**
+ Do we need a deterministic or stochastic model?  **A stochastic model would allow us to explore variation in the early stages of the outbreak**
+ What is the outcome of interest? **Number of infections**
+ Will any interventions be modelled? **No**

#### `model_default_cpp()`

A deterministic SEIR model with age specific direct transmission. 

```{r diagram, echo = FALSE, message = FALSE}
DiagrammeR::grViz("digraph {

  # graph statement
  #################
  graph [layout = dot,
         rankdir = LR,
         overlap = true,
         fontsize = 10]

  # nodes
  #######
  node [shape = square,
       fixedsize = true
       width = 1.3]

       S
       E
       I
       R

  # edges
  #######
  S -> E [label = ' infection (&beta;)']
  E -> I [label = ' onset of \ninfectiousness (&alpha;)']
  I -> R [label = ' recovery (&gamma;)']

}")
```


The model is capable of predicting an Ebola type outbreak, but as the model is deterministic, we are not able to explore stochastic variation in the early stages of the outbreak.


#### `model_ebola_r()`

A stochastic SEIHFR (Susceptible, Exposed, Infectious, Hospitalised, Funeral, Removed) model that was developed specifically for infection with Ebola. The model has stochasticity in the passage times between states, which are modelled as Erlang distributions.

The key parameters affecting the transition between states are:

+ $R_0$, the basic reproduction number,
+ $\rho^I$, the mean infectious period,
+ $\rho^E$, the mean preinfectious period,
+ $p_{hosp}$ the probability of being transferred to the hospitalised compartment. 

```{r, echo = FALSE, message = FALSE}
DiagrammeR::grViz("digraph {

  # graph statement
  #################
  graph [layout = dot,
  rankdir = LR,
  overlap = true,
  fontsize = 10]

  # nodes
  #######
  node [shape = square,
       fixedsize = true
       width = 1.3]

       S
       E
       I
       H
       F
       R

  # edges
  #######
  S -> E [label = ' infection (&beta;)']
  E -> I [label = ' onset of \ninfectiousness (&gamma; E)']
  I -> F [label = ' death (funeral) \n(&gamma; I)']
  F -> R [label = ' safe burial (one timestep) ']
  I -> H [label = ' hospitalisation (p hosp)']
  H -> R [label = ' recovery or safe burial \n (&gamma; I)']

  subgraph {
    rank = same; I; F;
  }
  subgraph {
    rank = same; H; R;
  }
}")
```

The model has additional parameters describing the transmission risk in hospital and funeral settings: 

+ $p_{ETU}$, the proportion of hospitalised cases contributing to the infection of susceptibles (ETU = Ebola virus treatment units),
+ $p_{funeral}$, the proportion of funerals at which the risk of transmission is the same as of infectious individuals in the community.

As this model is stochastic, it is the most appropriate choice to explore how variation in numbers of infected individuals in the early stages of an Ebola outbreak. 


:::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::: challenge

## Running the model

You have been tasked to generate initial trajectories of an Ebola outbreak in Guinea. Using `model_ebola_r()` and the the information detailed below, complete the following tasks:

1. Run the model once and plot the number of infectious individuals  through time
2. Run model 100 times and plot the mean, upper and lower 95% quantiles of the number of infectious individuals through time

+ Population size : 14 million
+ Initial number of exposed individuals : 10
+ Initial number of infectious individuals : 5
+ Time of simulation : 120 days
+ Parameter values : 
  + $R_0$ (`r0`) = 1.1,
  + $p^I$ (`infectious_period`) = 12,
  + $p^E$ (`preinfectious_period`) = 5,
  + $1-p_{hosp}$ (`prop_community`) = 0.9,
  + $p_{ETU}$ (`etu_risk`) = 0.7,
  + $p_{funeral}$ (`funeral_risk`) = 0.5


**Note: the functional relationship between the preinfectious  period ($\rho^E$) and the transition rate between exposed and infectious ($\gamma^E$) is $\rho^E = k^E/\gamma^E$ where $k^E$ is the shape of the Erlang distribution. Similarly for the infectious period $\rho^I = k^I/\gamma^I$. See [here](https://epiverse-trace.github.io/epidemics/articles/ebola_model.html#details-discrete-time-ebola-virus-disease-model) for more detail on the stochastic model formulation. ** 


::::::::::::::::: spoiler

### Code for initial conidtions 

```{r}
# set population size
population_size <- 14e6

E0 <- 10
I0 <- 5
# prepare initial conditions as proportions
initial_conditions <- c(
  S = population_size - (E0+I0), E = E0, I = I0, H = 0, F = 0, R = 0
) / population_size

guinea_population <- population(
  name = "Guinea",
  contact_matrix = matrix(1), # note dummy value
  demography_vector = population_size, # 14 million, no age groups
  initial_conditions = matrix(
    initial_conditions,
    nrow = 1
  )
)
```


::::::::::::::::::::::


::::::::::::::::: hint

### HINT : Multiple model simulations

Adapt the code from the [accounting for uncertainty](#accounting-for-uncertainty) section

::::::::::::::::::::::

::::::::::::::::: solution

### SOLUTION

1. Run the model once and plot the number of infectious individuals  through time


```{r}
# Prepare ebola parameters as an infection class object
ebola <- infection(
  name = "ebolavirus disease",
  r0 = 1.1,
  infectious_period = 12,
  preinfectious_period = 5,
  prop_community = 0.9,
  etu_risk = 0.7,
  funeral_risk = 0.5
)

output <- model_ebola_r(
  population = guinea_population,
  infection = ebola,
  time_end = 100
)

ggplot(output[compartment == "infectious", ]) +
  geom_line(
    aes(time, value),
    linewidth = 1
  ) +
  scale_y_continuous(
    labels = scales::comma,
    name = "Infectious indivduals"
  ) +
  labs(
    x = "Model time (days)"
  ) +
  theme_classic() +
  theme(
    legend.position = "top"
  ) +
  theme_grey(
    base_size = 15
  )

```

2. Run model 100 times and plot the mean, upper and lower 95% quantiles of the number of infectious individuals through time

We run the model 100 times with the *same* parameter values, so we do not need to re-write the infection object within the loop. 

```{r}
output_samples <- Map(
  x = seq(100),
  f = function(x) {
    output <- model_ebola_r(
      population = guinea_population,
      infection = ebola,
      time_end = 100
    )
    
    # add replicate number and return data
    output$replicate <- x
    output
  }
)

output_samples <- bind_rows(output_samples) # requires the tidyverse package

ggplot(output_samples[compartment == "infectious"] ,aes(time, value)) +
  stat_summary(geom = "line", fun = mean) +
  stat_summary(geom = "ribbon", 
               fun.min = function(z) { quantile(z, 0.025) },
               fun.max = function(z) { quantile(z, 0.975) }, 
               alpha = 0.3) +
  theme_grey(
    base_size = 15
  )
```

:::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::::::::::::::



::::::::::::::::::::::::::::::::::::: keypoints 

- Existing models can be used for new questions
- Check that a model has appropriate assumptions about transmission, outbreak potential, outcomes and interventions 
::::::::::::::::::::::::::::::::::::::::::::::::
