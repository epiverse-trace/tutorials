---
title: 'delays-refresher'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How to calculate the naive case fatality risk (CFR)?
- How to calculate delays using line list data?
- How to visualize transmission patterns using line list data?
- How to fit a probability distribution to delay data?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Use the pipe operator `%>%` to structure sequences of data operations left-to-right.
- Count observations in each group using `count()`.
- Pivot data from wide-to-long or long-to-wide using `pivot_*`.
- Create new columns that are functions of existing variables using `mutate()`.
- Keep or drop columns by their names using `select()`.
- Keep rows that match a condition using `filter()`.
- Extract a single column using `pull()`.
- Create graphics declaratively using `{ggplot2}`.

::::::::::::::::::::::::::::::::::::::::::::::::

:::::::::: prereq

### Setup a project and folder

- Create an RStudio project. If needed, follow this [how-to guide on "Hello RStudio Projects"](https://docs.posit.co/ide/user/ide/get-started/#hello-rstudio-projects) to create one.
- Inside the RStudio project, create the `data/` folder.
- Inside the `data/` folder, save the [linelist.rds](https://epiverse-trace.github.io/tutorials/data/linelist.rds) file.

::::::::::

::::::::::::::: checklist

let's create a Rmd or quarto file!

<https://quarto.org/docs/get-started/hello/rstudio.html>

<!-- https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1012018 -->

:::::::::::::::

## Introduction

A new Ebola virus (EVD) outbreak in a fictitious West African country

- Person-to-person transmission of infectious diseases 

```{r}
# new Ebola virus outbreak ------------------------------------------------

#' what we know?
#' - disease: Ebola
#' - location: western Africa
#' - data collection: cases are registered in the hospital

```


```{r,eval=TRUE,message=FALSE,warning=FALSE}
# Load packages
library(tidyverse) # for {dplyr} functions and the pipe %>%
```

## Explore data

```{r,eval=FALSE,echo=TRUE,message=FALSE}
# Read data
# e.g.: if path to file is data/simulated_ebola_2.csv then:
cases <- read_rds(
  here::here("data", "linelist.rds")
)
```

```{r,eval=TRUE,echo=FALSE,message=FALSE}
# Read data
cases <- read_rds(
  file.path("data", "linelist.rds")
)
```

```{r, message=FALSE}
cases
```

:::::::::::::::::::: checklist

### Why should we use the {here} package?

The `{here}` package is designed to simplify file referencing in R projects by providing a reliable way to construct file paths relative to the project root. The main reason to use it is **Cross-Environment Compatibility**.

It works across different operating systems (Windows, Mac, Linux) without needing to adjust file paths. 

- On Windows, paths are written using backslashes ( `\` ) as the separator between folder names: `"data\raw-data\file.csv"` 
- On Unix based operating system such as macOS or Linux the forward slash ( `/` ) is used as the path separator: `"data/raw-data/file.csv"`

The `{here}` package is ideal for adding one more layer of reproducibility to your work. If you are interested in reproducibility, we invite you to [read this tutorial to increase the openess, sustainability, and reproducibility of your epidemic analysis with R](https://epiverse-trace.github.io/research-compendium/)

::::::::::::::::::::

```{r}
# quality evaluation ------------------------------------------------------

cases %>%
  glimpse()

cases %>%
  cleanepi::scan_data()

# why do we have missing on infection date or outcome? -------------------

#' date of infection: unknown, contact tracing research, recall bias
#' outcome: reporting delay

cases %>%
  visdat::vis_miss()
```

## Calculate severity

```{r}
# severity ----------------------------------------------------------------

# case fatality risk -----------------------------------------------------

cases %>%
  count(outcome)

# should I consider missing outcomes for CFR? -----------------------------

cases %>%
  count(outcome) %>%
  pivot_wider(names_from = outcome, values_from = n) %>%
  cleanepi::standardize_column_names() %>%
  mutate(cases_known_outcome = death + recover)
```

:::::::::::: challenge

Calculate the CFR as the division of known deaths among known outcomes. Do this by adding one more pipe `%>%` in the last code chunk. Report:

- What is the value of the _naive_ CFR?

:::::::::::: hint

You can use the column names of the reminder data set to create a new column.

```{r,eval=FALSE,echo=TRUE}
cases %>%
  count(outcome) %>%
  pivot_wider(names_from = outcome, values_from = n) %>%
  cleanepi::standardize_column_names() %>%
  mutate(cases_known_outcome = death + recover) %>%
  mutate(cfr = ... / ...) # replace the ... spaces
```

::::::::::::

:::::::::::: solution

```{r}
cases %>%
  count(outcome) %>%
  pivot_wider(names_from = outcome, values_from = n) %>%
  cleanepi::standardize_column_names() %>%
  mutate(cases_known_outcome = death + recover) %>%
  mutate(cfr = death / cases_known_outcome)
```

This calculation is _naive_ because it tends to yield a biased and mostly underestimated CFR due to the time-delay from onset to death, only stabilising at the later stages of the outbreak.

::::::::::::

::::::::::::

However, how much time it would take for us register those outcomes? For this we need to calculate delays!

## Calculate delays

The time between sequence of dated events can vary between subjects.

```{r,echo=FALSE,eval=TRUE}
# demo code not to run by learner
set.seed(99)

cases_select <- cases %>%
  slice_sample(n = 30) %>%
  arrange(date_of_onset) %>%
  mutate(case_id = fct_inorder(case_id)) %>%
  # slice(10:40) %>%
  select(
    case_id,
    date_of_onset,
    date_of_hospitalisation
  )

cases_long <- cases_select %>%
  pivot_longer(cols = -case_id,names_to = "date_type",values_to = "date") %>% 
  mutate(date_type = fct_relevel(date_type, "date_of_onset")) 

ggplot() +
  geom_segment(
    data = cases_select,
    aes(x = date_of_onset, y = case_id, 
        xend = date_of_hospitalisation, yend = case_id),
    color = "grey"
  ) +
  geom_point(
    data = cases_long,
    aes(x = date,y = case_id, color = date_type),
    alpha = 0.5, size = 3
  ) +
  colorspace::scale_color_discrete_diverging(palette = "Blue-Red 2")
```

```{r,warning=FALSE,message=FALSE}
#' date of hospitalization means the date of report

cases %>%
  select(case_id, date_of_onset, date_of_hospitalisation) %>%
  mutate(reporting_delay = date_of_hospitalisation - date_of_onset) %>%
  ggplot(aes(x = reporting_delay)) +
  geom_histogram(binwidth = 1)
```


::::::::::::::::: challenge

Calculate the delay from onset to death.

::::::::::::: hint

We can keep the rows that match a given logical statement, like `outcome == "Death"`, using the function `dplyr::filter()`:

```{r,eval=FALSE,echo=TRUE}
cases %>%
  dplyr::filter(outcome == "Death")
```

:::::::::::::

::::::::::::: solution

```{r,warning=FALSE,message=FALSE}
cases %>%
  dplyr::select(case_id, date_of_onset, date_of_outcome, outcome) %>%
  dplyr::filter(outcome == "Death") %>%
  dplyr::mutate(delay_onset_death = date_of_outcome - date_of_onset) %>%
  ggplot(aes(x = delay_onset_death)) +
  geom_histogram(binwidth = 1)
```

Wait! Is is consistent to have negative time delays from primary to secondary observations, like from date of onset to date of death?

In the next episode we will learn how to check sequence of dated-events and more inconsistencies!

We can use `dplyr::filter()` again to identify the inconsistent observations:

```{r}
cases %>%
  dplyr::select(case_id, date_of_onset, date_of_outcome, outcome) %>%
  dplyr::filter(outcome == "Death") %>%
  dplyr::mutate(delay_onset_death = date_of_outcome - date_of_onset) %>% 
  dplyr::filter(delay_onset_death<1)
```


:::::::::::::

:::::::::::::::::


## Visualize transmission

- Incidence curve

aggregate the date by intervals of 7 days

```{r}

# transmission ------------------------------------------------------------

# incidence curve ---------------------------------------------------------

cases %>%
  ggplot(aes(x = date_of_onset)) +
  geom_histogram(binwidth = 7)

# what transmission indicator can we estimate from the incidence curve? ---

#' the growth rate! by fitting a linear model
#' more on that on DAY 3-4

# what is the name of the delay from infection to symptom onset? ----------
```

However, as seen before, the date of onset of symptoms is a delayed measurement with respect to the date of infection.

There is an average time delay between the date of infection, date of onset, date of hospitalisation, and date of outcome.

```{r,eval=TRUE,echo=FALSE,warning=FALSE,message=FALSE}
library(tidyverse)
outbreaks::ebola_sim_clean$linelist %>%
  # slice_sample(n = 166) %>%
  dplyr::as_tibble() %>% 
  incidence2::incidence(
    date_index = c(
      "date_of_infection",
      "date_of_onset",
      "date_of_outcome"
    ),
    interval = "week",
    complete_dates = TRUE
  ) %>% 
  dplyr::mutate(
    count_variable = fct_relevel(
      count_variable,
      "date_of_infection",
      "date_of_onset",
      "date_of_outcome"
    )
  ) %>%
  plot(
    # show_cases = TRUE, 
    angle = 45,
    n_breaks = 15
  ) +
  geom_vline(xintercept = grates::as_isoweek(ymd(20140825)), linetype = 3)
```

In order to account for these time delays when estimating indicators of severity or transmission, we need to input delays as **Probability Distributions**!

::::::::::::::::::: prereq

**Watch** one 5-minute video refresher on probability distributions:

- StatQuest with Josh Starmer (2017) 
**The Main Ideas behind Probability Distributions**, YouTube. 
Available at: <https://www.youtube.com/watch?v=oI3hZJqXJuc&t> 
<!--(Accessed: 30 October 2024).-->

:::::::::::::::::::

## Try to fit a probability distribution to delays

```{r,warning=FALSE,message=FALSE}
cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  ggplot(aes(x = incubation_period)) +
  geom_histogram(binwidth = 1)
```


```{r}
cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  mutate(incubation_period_num = as.numeric(incubation_period)) %>%
  filter(!is.na(incubation_period_num)) %>%
  pull(incubation_period_num) %>%
  fitdistrplus::fitdist(distr = "lnorm") # try: summary and plot

#' explore the
#' https://ben18785.shinyapps.io/distribution-zoo/
#' for gamma, weibull, lnorm parameters
```

::::::::::::::: callout

### the dollar sign `$` can `pull()`

```{r}
cases_delay <- cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  mutate(incubation_period_num = as.numeric(incubation_period)) %>%
  filter(!is.na(incubation_period_num))
```

```{r}
cases_delay %>% pull(incubation_period_num)
```

Try this yourself:

```{r,eval=FALSE,echo=TRUE}
cases_delay$incubation_period_num
```

:::::::::::::::

::::::::::::::: callout

### the dollar sign `$` can `pluck()`

```{r}
incubation_period_fit <- cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  mutate(incubation_period_num = as.numeric(incubation_period)) %>%
  filter(!is.na(incubation_period_num)) %>%
  pull(incubation_period_num) %>%
  fitdistrplus::fitdist(distr = "lnorm")
```

```{r}
incubation_period_fit %>% pluck("estimate")
```

Try this yourself:

```{r,eval=FALSE,echo=TRUE}
incubation_period_fit$estimate
```

But, how do you access to the specific parameter?

:::::::::::::::

:::::::::::::::::::::::::::::: testimonial

### A code completion tip

If we write the **square brackets** `[]` next to the object `incubation_period_fit$estimate[]`, within `[]` we can use the 
Tab key <kbd>↹</kbd> 
for [code completion feature](https://support.posit.co/hc/en-us/articles/205273297-Code-Completion-in-the-RStudio-IDE) 

This gives quick access to `incubation_period_fit$estimate["meanlog"]` and `incubation_period_fit$estimate["sdlog"]`. 

We invite you to try this out in code chunks and the R console!

::::::::::::::::::::::::::::::

## Why to fit a probability distribution to data?

```{r}
# why to fit a distribution to observed data? -----------------------------

#' the time difference from date infection and date symptom onset
#' give us the incubation period
#'
#' steps
#' - calculate the time difference
#' - plot
#' - fit a probability distribution (obtain distribution parameters)
#' - do inferences
#'
#' from the incubation period distribution
#' we can infer the length of active monitoring or quarantine
#' example
#' within what time frame do 99% of individuals
#' exhibiting Ebola symptoms exhibit them after infection?

#' review probability functions
qlnorm(p = 0.99, meanlog = 1.995979, sdlog = 0.776226)

#' reference: https://pubmed.ncbi.nlm.nih.gov/32150748/
#' Lauer, 2020
#' The Incubation Period of Coronavirus Disease 2019 (COVID-19)
#' From Publicly Reported Confirmed Cases: Estimation and Application
```

::::::::::::::: testimonial

### What to do if we do not have enough data?

```{r}
# but this fitting step requires account for biases! ----------------------

# what to do when we do not have all these dates or info on biases? -------

#' we are going to clean and standardize data on
#' DAY 2 afternoon
#' validate, rearrange, visualize epicurve data on
#' DAY 3 morning
#' we can reuse data from past outbreaks!
#' DAY 3 afternoon
#' and took them to account for delays for transmission and severity
#' DAY 4 morning and afternoon
```

:::::::::::::::

```{r}
# challenge ----------------------------------------------------------------

# use epidemiological times figure TRACE LAC ------------------------------

#' PAHO figure
#' if we have the serial interval
#' we can make inferences about the window for contact tracing
#' expand the number of pre-days to include more backward contacts
```

::::::::::::::: checklist

<!-- CHECKPOINT! let's create a reprex! -->

<https://community.appliedepi.org/t/how-to-make-a-reproducible-r-code-example/167>

:::::::::::::::

::::::::::::::::::::::::::::::::::::: keypoints 

- Use packages from the `tidyverse` like `{dplyr}`, `{tidyr}`, and `{ggplot}` for exploratory data analysis.
- Epidemiological delays conditions the estimation of indicators for severity or transmission. 
- Fit probability distribution to delays to make inferences from them for decision making.

::::::::::::::::::::::::::::::::::::::::::::::::

