---
title: 'delays-refresher'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How to calculate the naive case fatality risk (CFR)?
- How to calculate delays using line list data?
- How to visualize transmission patterns using line list data?
- How to fit a statistical distribution to delay data?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Use the pipe operator `%>%` to structure sequences of data operations left-to-right.
- Count observations in each group using `count()`.
- Pivot data from wide-to-long or long-to-wide using `pivot_*`.
- Create new columns that are functions of existing variables using `mutate()`.
- Keep or drop columns by their names using `select()`.
- Keep rows that match a condition using `filter()`.
- Extract a single column using `pull()`.
- Create graphics declaratively using `{ggplot2}`.

::::::::::::::::::::::::::::::::::::::::::::::::


#### Basic concepts to be developed

The following concepts will be developed in this practice:


- Person-to-person transmission of infectious diseases 



- Incidence curve

:::::::::: prereq

### Setup a project and folder

- Create an RStudio project. If needed, follow this [how-to guide on "Hello RStudio Projects"](https://docs.posit.co/ide/user/ide/get-started/#hello-rstudio-projects) to create one.
- Inside the RStudio project, create the `data/` folder.
- Inside the `data/` folder, save the [linelist.rds](https://epiverse-trace.github.io/tutorials/data/linelist.rds) file.

::::::::::

## Introduction

A new Ebola virus (EVD) outbreak in a fictitious West African country

```{r}
# new Ebola virus outbreak ------------------------------------------------

#' what we know?
#' - disease: Ebola
#' - location: western Africa
#' - data collection: cases are registered in the hospital

```


```{r,eval=TRUE,message=FALSE,warning=FALSE}
# Load packages
library(tidyverse) # for {dplyr} functions and the pipe %>%
```

## Explore data

```{r,eval=FALSE,echo=TRUE,message=FALSE}
# Read data
# e.g.: if path to file is data/simulated_ebola_2.csv then:
cases <- read_rds(
  here::here("data", "linelist.rds")
)
```

```{r,eval=TRUE,echo=FALSE,message=FALSE}
# Read data
cases <- read_rds(
  file.path("data", "linelist.rds")
)
```

```{r, message=FALSE}
cases
```

```{r}
# quality evaluation ------------------------------------------------------

cases

cases %>%
  glimpse()

cases %>%
  cleanepi::scan_data()

# why do we have missing on infection date or outcome? -------------------

#' date of infection: unknown, contact tracing research, recall bias
#' outcome: reporting delay

cases %>%
  visdat::vis_miss()
```

## Calculate severity

```{r}
# severity ----------------------------------------------------------------

# case fatality risk -----------------------------------------------------

cases %>%
  count(outcome)

# should I consider missing outcomes for CFR? -----------------------------

cases %>%
  count(outcome) %>%
  pivot_wider(names_from = outcome, values_from = n) %>%
  cleanepi::standardize_column_names() %>%
  mutate(cases_known_outcome = death + recover)
```

:::::::::::: challenge

Calculate the CFR as the division of known deaths among known outcomes. Do this by adding one more pipe `%>%` in the last code chunk. Report:

- What is the value of the naive CFR?

:::::::::::: hint

You can use the column names of the reminder data set to create a new column.

```{r,eval=FALSE,echo=TRUE}
cases %>%
  count(outcome) %>%
  pivot_wider(names_from = outcome, values_from = n) %>%
  cleanepi::standardize_column_names() %>%
  mutate(cases_known_outcome = death + recover) %>%
  mutate(cfr = ... / ... ) # replace the ... spaces
```

::::::::::::

:::::::::::: solution

```{r}
cases %>%
  count(outcome) %>%
  pivot_wider(names_from = outcome, values_from = n) %>%
  cleanepi::standardize_column_names() %>%
  mutate(cases_known_outcome = death + recover) %>%
  mutate(cfr = death / cases_known_outcome)
```

::::::::::::

::::::::::::

However, how much time it would take for us register those outcomes?

```{r,echo=FALSE,eval=TRUE}
# demo code not to run by learner
cases %>%
  slice_sample(n = 30) %>% 
  arrange(date_of_onset) %>%
  mutate(case_id = fct_inorder(case_id)) %>%
  # slice(10:40) %>%
  select(
    x = case_id,
    value1 = date_of_onset,
    value2 = date_of_hospitalisation
  ) %>%
  ggplot() +
  geom_segment(
    aes(x = x, xend = x, y = value1, yend = value2),
    color = "grey"
  ) +
  geom_point(
    aes(x = x, y = value1),
    color = "darkgreen",
    size = 3,
    alpha = 0.5
  ) +
  geom_point(
    aes(x = x, y = value2),
    color = "red",
    size = 3,
    alpha = 0.5
  ) +
  coord_flip()
```

## Calculate delays

```{r}
#' date of hospitalization means the date of report

cases %>%
  select(case_id, date_of_onset, date_of_hospitalisation) %>%
  mutate(reporting_delay = date_of_hospitalisation - date_of_onset) %>%
  ggplot(aes(x = reporting_delay)) +
  geom_histogram(binwidth = 1)
```


::::::::::::::::: challenge

Calculate the delay from onset to death.

::::::::::::: hint

We can keep the rows that match the following logical statement: `outcome == "Death"`.

```{r,eval=FALSE,echo=TRUE}
cases %>%
  filter(outcome == "Death")
```

:::::::::::::

::::::::::::: solution

```{r}
cases %>%
  select(case_id, date_of_onset, date_of_outcome, outcome) %>%
  filter(outcome == "Death") %>% 
  mutate(delay_onset_death = date_of_outcome - date_of_onset) %>%
  ggplot(aes(x = delay_onset_death)) +
  geom_histogram(binwidth = 1)
```

Is is consistent to have negative delays from secondary observations?

:::::::::::::

:::::::::::::::::


## Visualize transmission

aggregate the date by intervals of 7 days

```{r}

# transmission ------------------------------------------------------------

# incidence curve ---------------------------------------------------------

cases %>%
  ggplot(aes(x = date_of_onset)) +
  geom_histogram(binwidth = 7)

# what transmission indicator can we estimate from the incidence curve? ---

#' the growth rate! by fitting a linear model
#' more on that on DAY 3-4

# what is the name of the delay from infection to symptom onset? ----------
```

```{r,eval=TRUE,echo=FALSE}
outbreaks::ebola_sim_clean$linelist %>%
  as_tibble() %>%
  arrange(date_of_infection) %>%
  rownames_to_column() %>% 
  mutate(rowname = as.numeric(rowname)) %>% 
  # slice_sample(n = 166) %>%
  # slice_head(n = 166) %>%
  mutate(
    looking = case_when(
      rowname <= 166 ~ "now",
      TRUE ~ "then"
    )
  ) %>% 
  # count(looking)
  slice_head(n = 100) %>%
  select(case_id, date_of_infection, date_of_onset) %>% 
  pivot_longer(cols = -case_id, names_to = "date_type", values_to = "date") %>% 
  count(date, date_type) %>% 
  group_by(date_type) %>% 
  mutate(cumulative = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = cumulative, color = date_type)) + 
  geom_line()
```


## Fit a statistical distribution to delays

```{r}
cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  ggplot(aes(x = incubation_period)) +
  geom_histogram(binwidth = 1)
```


```{r}
cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  mutate(incubation_period_num = as.numeric(incubation_period)) %>%
  filter(!is.na(incubation_period_num)) %>%
  pull(incubation_period_num) %>%
  fitdistrplus::fitdist(distr = "lnorm") # try: summary and plot

#' explore the
#' https://ben18785.shinyapps.io/distribution-zoo/
#' for gamma, weibull, lnorm parameters
```

::::::::::::::: callout

### the dollar sign `$` can `pull()`

```{r}
cases_delay <- cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  mutate(incubation_period_num = as.numeric(incubation_period)) %>%
  filter(!is.na(incubation_period_num))

cases_delay %>% pull(incubation_period_num)
```

```{r}
cases_delay$incubation_period_num
```

:::::::::::::::

::::::::::::::: callout

### the dollar sign `$` can `pluck()`

```{r}
incubation_period_fit <- cases %>%
  select(case_id, date_of_infection, date_of_onset) %>%
  mutate(incubation_period = date_of_onset - date_of_infection) %>%
  mutate(incubation_period_num = as.numeric(incubation_period)) %>%
  filter(!is.na(incubation_period_num)) %>%
  pull(incubation_period_num) %>%
  fitdistrplus::fitdist(distr = "lnorm")

incubation_period_fit %>% pluck("estimate")
```

```{r}
incubation_period_fit$estimate
```

:::::::::::::::

## Why to fit a distribution to data?

```{r}
# why to fit a distribution to observed data? -----------------------------

#' the time difference from date infection and date symptom onset
#' give us the incubation period
#'
#' steps
#' - calculate the time difference
#' - plot
#' - fit a distribution (obtain distribution parameters)
#' - do inferences
#'
#' from the incubation period distribution
#' we can infer the length of active monitoring or quarantine
#' example
#' within what time frame do 99% of individuals
#' exhibiting Ebola symptoms exhibit them after infection?

#' review probability functions
qlnorm(p = 0.99, meanlog = 1.995979, sdlog = 0.776226)

#' reference: https://pubmed.ncbi.nlm.nih.gov/32150748/
#' Lauer, 2020
#' The Incubation Period of Coronavirus Disease 2019 (COVID-19)
#' From Publicly Reported Confirmed Cases: Estimation and Application
```

::::::::::::::: testimonial

### What to do if we do not have enough data?

```{r}
# but this fitting step requires account for biases! ----------------------

# what to do when we do not have all these dates or info on biases? -------

#' we are going to clean and standardize data on
#' DAY 2 afternoon
#' validate, rearrange, visualize epicurve data on
#' DAY 3 morning
#' we can reuse data from past outbreaks!
#' DAY 3 afternoon
#' and took them to account for delays for transmission and severity
#' DAY 4 morning and afternoon
```

:::::::::::::::

```{r}
# challenge ----------------------------------------------------------------

# use epidemiological times figure TRACE LAC ------------------------------

#' PAHO figure
#' if we have the serial interval
#' we can make inferences about the window for contact tracing
#' expand the number of pre-days to include more backward contacts
```


::::::::::::::::::::::::::::::::::::: keypoints 

- Use packages from the `tidyverse` like `{dplyr}`, `{tidyr}`, and `{ggplot}` for exploratory data analysis.
- Epidemiological delays conditions the estimation of indicators for severity or transmission. 
- Fit statistical distribution to delays to make inferences from them for decision making.

::::::::::::::::::::::::::::::::::::::::::::::::

