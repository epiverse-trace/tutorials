---
title: 'Simulating transmission scenarios'
teaching: 10 # teaching time in minutes
exercises: 5 # exercise time in minutes
---

:::::::::::::::::::::::::::::::::::::: questions 

- How do I generate predictions of disease trajectories?
- What model structure do I need?
- How do I read in a social contact matrix? 


::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

Using the R package `epidemics`, learn how to: 

- load an existing model structure,
- load an existing social contact matrix,
- run a model simulation using.

::::::::::::::::::::::::::::::::::::::::::::::::

## Introduction

Introductory text, `epidemics`

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

Inline instructor notes can help inform instructors of timing challenges
associated with the lessons. They appear in the "Instructor View"

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisties

List (and hyperlink) the lessons/packages which need to be covered before this lesson

:::::::::::::::::::::::::::::::::

## Model structures
To generate predictions of infectious disease trajectories, we must first select a mathematical model to use.

In `epidemics` models are defined as either *epidemic* models or *outbreak* models. *Epidemic* models focus on directly transmitted diseases with pandemic potential (such as influenza and Covid), and *outbreak* models,  focus on diseases that are not expected to have pandemic potential (such as Ebola).

There is a library of epidemic and outbreak models to choose from in `epidemics`. Models are prefixed with either epidemic or outbreak, and suffixed by the infection name. In this tutorial, we will use the default epidemic model, `epidemic_default` which is described in the next section.

<!-- To view this library XXX.. -->

::::::::::::::::::::::::::::::::::::: callout
### Check model equations
When using existing model structures always check the model assumptions. Ask questions such as:

- How is transmission modelled?
- What interventions are modelled? 
- What state variables are there and how do they relate to assumptions about infection?

There can be subtle differences in model structures for the same infection/outbreak type which can be missed without studying the equations.
::::::::::::::::::::::::::::::::::::::::::::::::


### An epidemic model

The default epidemic model is an age-structured SEIR-V model described by a system of ordinary differential equations. For each age group $i$, individuals are classed as either susceptible $S$, infected but not yet infectious $E$, infectious $I$, recovered $R$ or vaccinated $V$. 

The model parameters and equations are as follows :

- transmission rate $\beta$
- contact matrix $C_{i,j}$ (rows $i$ and columns $j$)
- rate of becoming infectious $\alpha$
- recovery rate $\gamma$
- time dependent vaccination rate $\nu_t$.


$$
\begin{aligned}
\frac{dS_i}{dt} & = - \beta S_i \sum_j C_{i,j} I_j -\nu_{t} S_i \\
\frac{dE_i}{dt} &= \beta S_i\sum_j C_{i,j} I_j - \alpha E_i \\
\frac{dI_i}{dt} &= \alpha E_i - \gamma I_i \\
\frac{dR_i}{dt} &=\gamma I_i \\
\frac{dV_i}{dt} &=\nu_{t} S_i\\
\end{aligned}
$$

From the model structure we see that :

- there is heterogeneity in contacts between age groups,
- there is no loss of immunity,
- only susceptibles are vaccinated.

To generate trajectories using our model, we need the following :  

1.  contact matrix,
2.  demographic structure,
3.  parameter values,
4.  initial conditions. 

## Contact matrix and demography

<!-- Introduce social contact matrix  -->


::::::::::::::::::::::::::::::::::::: challenge 

## Load contact and population data

Using the R package `socialmixr`, run the following lines of R code to obtain the contact matrix for the United Kingdom for the year age bins:

+ [0,20)
+ [20, 40)
+ 40 +


```r
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)
contact_matrix
```

:::::::::::::::::::::::: solution 

## Output
 
```{r polymod_uk, echo = FALSE}
 polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)
contact_matrix
```


:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::

<!-- Demography vector  -->

```{r demography}
# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)
demography_vector
```

::::::::::::::::::::::::::::::::::::: challenge 

## Load contact and population data for Poland

Load contact and population data for Poland from socialmixr::polymod using the following age bins:

+ [0,15)
+ [15, 50)
+ 50 +

:::::::::::::::::::::::: solution 

```{r polymod_poland}
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "Poland",
  age.limits = c(0, 15, 50),
  symmetric = TRUE
)
contact_data
```
:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::

## Model parameters

### Example


<!-- ### Load parameters from previous lessons  -->


## Running simulations

<!-- Simulate without interventions. Initial conditions, prepare population, output, visualize  -->


::::::::::::::::::::::::::::::::::::: keypoints 

- Summarise the key points of the lesson using bullet points


::::::::::::::::::::::::::::::::::::::::::::::::
