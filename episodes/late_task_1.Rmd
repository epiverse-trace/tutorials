---
title: 'Simulating transmission scenarios'
teaching: 10 # teaching time in minutes
exercises: 5 # exercise time in minutes
---

```{r setup, echo= FALSE}
library(epidemics)
```


:::::::::::::::::::::::::::::::::::::: questions 

- How do I generate predictions of disease trajectories?
- What model structure do I need?
- How do I read in a social contact matrix? 

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

Using the R package `epidemics`, learn how to: 

- load an existing model structure,
- load an existing social contact matrix,
- run a model simulation using.

::::::::::::::::::::::::::::::::::::::::::::::::

## Introduction

In this tutorial, we will use the R package `epidemics` to generate trajectories of disease spread.

<!-- Why do we generate predictoins, add example plot -->

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

Inline instructor notes can help inform instructors of timing challenges
associated with the lessons. They appear in the "Instructor View"

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

The first step is to install the R packages `epidemics`.

```{r installation, eval = FALSE}
if(!require("pak")) install.packages("pak")
pak::pak("epiverse-trace/epidemics")
```

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites
+ Prior knowledge of ordinary differential equations is beneficial 
:::::::::::::::::::::::::::::::::

## Model structures
To generate predictions of infectious disease trajectories, we must first select a mathematical model to use.

In `epidemics` models are defined as either *epidemic* models or *outbreak* models. *Epidemic* models focus on directly transmitted diseases with pandemic potential (such as influenza and Covid), and *outbreak* models,  focus on diseases that are not expected to have pandemic potential (such as Ebola).

There is a library of epidemic and outbreak models to choose from in `epidemics`. Models are prefixed with either epidemic or outbreak, and suffixed by the infection name. In this tutorial, we will use the default epidemic model, `epidemic_default` which is described in the next section.

<!-- To view this library XXX.. -->

::::::::::::::::::::::::::::::::::::: callout
### Check model equations
When using existing model structures always check the model assumptions. Ask questions such as:

- How is transmission modelled?
- What interventions are modelled? 
- What state variables are there and how do they relate to assumptions about infection?

There can be subtle differences in model structures for the same infection/outbreak type which can be missed without studying the equations.
::::::::::::::::::::::::::::::::::::::::::::::::


### An epidemic model

The default epidemic model is an age-structured SEIR-V model described by a system of ordinary differential equations. For each age group $i$, individuals are classed as either susceptible $S$, infected but not yet infectious $E$, infectious $I$, recovered $R$ or vaccinated $V$. 

The model parameters and equations are as follows :

- transmission rate $\beta$,
- contact matrix $C$ (a square $i \times j$ matrix),
- rate of transition from exposed to infectious $\alpha$ (preinfectious period=$1/\alpha$),
- recovery rate $\gamma$ (infectious period = $1/\gamma$),
- time dependent vaccination rate $\nu_t$.


$$
\begin{aligned}
\frac{dS_i}{dt} & = - \beta S_i \sum_j C_{i,j} I_j -\nu_{t} S_i \\
\frac{dE_i}{dt} &= \beta S_i\sum_j C_{i,j} I_j - \alpha E_i \\
\frac{dI_i}{dt} &= \alpha E_i - \gamma I_i \\
\frac{dR_i}{dt} &=\gamma I_i \\
\frac{dV_i}{dt} &=\nu_{t} S_i\\
\end{aligned}
$$

From the model structure we see that :

- there is heterogeneity in contacts between age groups,
- there is no loss of immunity,
- only susceptibles are vaccinated.

To generate trajectories using our model, we need the following :  

1.  parameter values,
2.  contact matrix,
3.  demographic structure,
4.  initial conditions. 


## Model parameters

To run our model we need to specify the model parameters. For this tutorial, we will assume there are no interventions (including vaccination). Therefore, the parameters we need values for are: 

- transmission rate $\beta$,
- rate of transition from exposed to infectious $\alpha$ (preinfectious period=$1/\alpha$),
- recovery rate $\gamma$ (infectious period=$1/\gamma$).

We will learn how to specify the contact matrix $C$ in the next lesson. 

::::::::::::::::::::::::::::::::::::: callout
### The basic reproduction number $R_0$
The basic reproduction number, $R_0$, for the SEIR model is: 

$$ R_0 = \frac{\beta}{\gamma}.$$ 

Therefore, we can rewrite the transmission rate, $\beta$, as:

$$ \beta = R_0 \gamma.$$


::::::::::::::::::::::::::::::::::::::::::::::::

In `epidemics`, we use the function `infection` to pass the values of, $R_0$, the preinfectious period ($1/\alpha$) and the infectious period ($1/\gamma$) as follows.

```{r, eval = FALSE}
influenza <- infection(
  name = "influenza",
  r0 = 1.5,
  preinfectious_period = 3,
  infectious_period = 7
)

```

<!-- ### Load parameters from previous lessons  -->


## Contact matrix and demography

<!-- Introduce social contact matrix, square matrix $i$ rows and $j$ columns  -->


::::::::::::::::::::::::::::::::::::: challenge 

## Load contact and population data

Using the R package `socialmixr`, run the following lines of R code to obtain the contact matrix for the United Kingdom for the year age bins:

+ [0,20)
+ [20, 40)
+ 40 +


```r
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)
contact_matrix
```

:::::::::::::::::::::::: solution 

## Output
 
```{r polymod_uk, echo = FALSE}
 polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)
contact_matrix
```


:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::

<!-- Demography vector  -->

```{r demography}
# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)
demography_vector
```

::::::::::::::::::::::::::::::::::::: challenge 

## Load contact and population data for Poland

Load contact and population data for Poland from socialmixr::polymod using the following age bins:

+ [0,15)
+ [15, 50)
+ 50 +

:::::::::::::::::::::::: solution 

```{r polymod_poland}
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "Poland",
  age.limits = c(0, 15, 50),
  symmetric = TRUE
)
contact_data
```
:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::


## Running simulations

<!-- Simulate without interventions. Initial conditions, prepare population, output, visualize  -->


::::::::::::::::::::::::::::::::::::: keypoints 

- Summarise the key points of the lesson using bullet points


::::::::::::::::::::::::::::::::::::::::::::::::
