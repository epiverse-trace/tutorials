---
title: 'Quantifying transmissibility'
teaching: 30
exercises: 0
---

```{r setup, echo= FALSE, warning = FALSE, message=FALSE}
require(EpiNow2);require(ggplot2); require(incidence2)
require(webshot)
webshot::install_phantomjs(force = TRUE)
```

:::::::::::::::::::::::::::::::::::::: questions 

- How can I estimate key transmissibility metrics from case data?
- How can I quantify transmissibility heterogeneity in these metrics? 


::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Learn how to estimate transmissibility metrics from case data using the R package `EpiNow2`

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites

This tutorial has the following concept dependencies: 

**Statistics** : probability distributions, principle of Bayesian analysis. 

**Epidemic theory** : Effective reproduction number.

:::::::::::::::::::::::::::::::::



::::::::::::::::::::::::::::::::::::: callout
### Reminder: the Effective Reproduction Number, $R_t$ 

The basic reproduction number, $R_0$, is the average number of cases caused by one infectious individual in a entirely susceptible population. 

But in an ongoing outbreak, the population is not entirely susceptible. Therefore we are more interested in the value of the **effective reproduction number**, $R_t$, the average number of cases caused by one infectious individual in the population at time $t$.

The effective reproduction number is related to $R_0$ as follows, 

$$R_t = s R_0.$$

where $s=S(t)/N$, the proportion of the population susceptible to infection.


::::::::::::::::::::::::::::::::::::::::::::::::


## Introduction

To estimate key metrics of transmissibility using case data we must account for delays between the date of infections and date of reported cases. In an outbreak situation, data are often available on reported dates only, therefore we must use estimation methods to account for these delays. 

In the next lessons we will focus on how to implement the functions in `{EpiNow2}` to estimate transmissibility features of case data. We will not cover the theoretical background of the models or inference framework, for details on these concepts see the  [vignette](https://epiforecasts.io/EpiNow2/dev/articles/estimate_infections.html).


::::::::::::::::::::::::::::::::::::: callout
### Bayesian inference

The R package `EpiNow2` uses a Bayesian inference framework to estimate reproduction numbers and infection times based on reporting dates.

In Bayesian inference, we use prior knowledge (prior distributions) with data (in a likelihood function) to find the posterior probability.

<p class="text-center" style="background-color: white">Posterior probability $\propto$ likelihood $\times$ prior probability
</p>

::::::::::::::::::::::::::::::::::::::::::::::::


The first step is to install the package :

```{r, eval = FALSE}
install.packages("EpiNow2")
library(EpiNow2)
```



:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

This lesson illustrates the usage of `epinow()` to estimate the time-varying reproduction number and infection times. Learners should understand the necessary inputs to the model and the limitations of the model output. 

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


## Delay distributions and case data 
### Case data

To illustrate the functions of `EpiNow2` we will use outbreak data of the start of the COVID-19 pandemic from the United Kingdom. The data are available in the R package `{incidence2}`. 

```{r}
head(incidence2::covidregionaldataUK)
```

To use the data, we must format the data to have two columns:

+ `date` : the date,
+ `confirm` : number of confirmed cases on that date.

```{r}
cases <- incidence2::covidregionaldataUK[, c("date", "cases_new")]
cases <- aggregate(x = cases$cases_new,
                     FUN = sum,
                     by = list(cases$date),
                     na.rm = TRUE)
colnames(cases) <- c("date", "confirm")
```


There are case data available for `r dim(cases)[1]` days, but in an outbreak situation it is likely we would only have access to the beginning of this data set. Therefore we assume we only have the first 90 days of this data. 

```{r echo = FALSE}
ggplot(cases[1:90,], aes(x = date, y = confirm)) +
  geom_col()
```



### Delay distributions 
We must specify a delay distribution from time of infection until time reported. This delay distribution can consist of multiple types of delays/processes. A typical delay distribution from time of infection to case notification may consist of :

<p class="text-center" style="background-color: aliceblue">**time from infection to symptom onset** (the latent period) + **time from symptom onset to case notification** (the reporting time)
.</p>

The delay distribution for each of these processes can either estimated from data or obtained from the literature. The distributions can also either be **fixed** (i.e. have no uncertainty) or **variable** (i.e. have associated uncertainty).

#### Latent period distribution 

The distribution of latent period can usually be obtained from the literature. The package `{epiparameter}` contains a library of epidemiological parameters for different diseases obtained from the literature. 

We specify a (fixed) gamma distribution with mean $\mu = 4$ and standard deviation $\sigma^2= 2$ (shape = $4$, scale = $1$) using the function `dist_spec()` as follows:

```{r}
latent_period_fixed <- dist_spec(
  mean = 4, sd = 2, 
  max = 20, distribution = "gamma"
)
latent_period_fixed 
```

The argument `max` is the maximum value the distribution can take, in this example 20 days. 

::::::::::::::::::::::::::::::::::::: callout
### Why a gamma distrubution? 

The latent period has to be positive in value. Therefore we must specific a distribution in `dist_spec` which is for positive values only. 

`dist_spec()` supports lognormal and gamma distributions, which are distributions for positive values only. 

For all types of delay, we will need to use distributions for positive values only - we don't want to include delays of negative days in our analysis!

::::::::::::::::::::::::::::::::::::::::::::::::



####  Including distribution uncertainty

To specify a **variable** distribution, we include uncertainty around the mean $\mu$ and standard deviation $\sigma^2$ of our gamma distribution. If our latent period distribution has a mean $\mu$ and standard deviation $\sigma^2$, then we assume the mean ($\mu$) follows a Normal distribution with standard deviation $\sigma_{\mu}^2$:

$$\mbox{Normal}(\mu,\sigma_{\mu}^2)$$

and a standard deviation ($\sigma^2$) follows a Normal distribution with standard deviation $\sigma_{\sigma^2}^2$:

$$\mbox{Normal}(\sigma^2,\sigma_{\sigma^2}^2).$$

We specify this using `dist_spec` with the additional arguments `mean_sd` ($\sigma_{\mu}^2$) and `sd_sd` ($\sigma_{\sigma^2}^2$).

```{r}
latent_period_variable <- dist_spec(
  mean = 4, sd = 2,
  mean_sd = 0.5, sd_sd = 0.5,
  max = 20, distribution = "gamma"
  )
latent_period_variable 
```



####  Reporting delays

After the latent period, there will be an additional delay of time from symptom onset to case notification : the reporting delay. We can specify this as a fixed or variable distribution, or estimate a distribution from data. 

When specifying a distribution, it is useful to visualise the probability density to see the peak and spread of the distribution, in this case we will use a lognormal distribution. We can use the functions `convert_to_logmean()` and `convert_to_logsd()` to  convert the mean and standard deviation of a normal distribution to that of a lognormal distribution. 

If we want to assume that the mean reporting delay is 2 days (with a standard deviation of 1 day), the lognormal distribution will look like: 

```{r}
log_mean <- convert_to_logmean(2, 1)
log_sd <- convert_to_logsd(2, 1) 
x <- seq(from = 0,to = 10 ,length = 1000)
df <- data.frame(x = x, density = dlnorm(x, meanlog = log_mean, sdlog = log_sd))
ggplot(df) +
  geom_line(aes(x, density))
```

Using the mean and standard deviation for the lognormal distribution, we can specify a fixed or variable distribution using `dist_spec()` as before: 

```{r}
reporting_delay_variable <- dist_spec(
  mean = log_mean, sd = log_sd,
  mean_sd = 0.5, sd_sd = 0.5,
  max = 10, distribution = "lognormal"
  )
```

If data is available on the time between symptom onset and reporting, we can use the function `estimate_delay()` to estimate a lognormal distribution from a vector of delays. The code below illustrates how to use `estimate_delay()` with synthetic delay data. 

```{r, eval = FALSE }
delay_data <- rlnorm(500, log(5), 1) # synthetic delay data 
reporting_delay <- estimate_delay(
  delay_data, samples = 1000, 
  bootstraps = 10
  )
```


####  Generation time

We also must specify a distribution for the generation time. Here we will use a lognormal distribution with mean 3.6 and standard deviation 3.1 ([Ganyani et al. 2020](https://doi.org/10.2807/1560-7917.ES.2020.25.17.2000257)).


```{r}
generation_time_variable <- dist_spec(
  mean = 3.6, sd = 3.1,
  mean_sd = 0.5, sd_sd = 0.5,
  max = 20, distribution = "lognormal"
)
```


## Finding estimates

The function `epinow()` is a wrapper for the function `estimate_infections()` used to estimate cases by date of infection. The generation time distribution and delay distributions must be passed using the functions ` generation_time_opts()` and `delay_opts()` respectively. 

There are numerous other inputs that can be passed to `epinow()`, see `EpiNow2::?epinow()` for more detail.
One optional input is to specify a lognormal prior for the effective reproduction number $R_t$ at the start of the outbreak. We specify a mean and standard deviation as arguments of `prior` within `rt_opts()`:

```{r, eval = FALSE}
rt_log_mean <- convert_to_logmean(2, 1)
rt_log_sd <- convert_to_logsd(2, 1) 
rt = rt_opts(prior = list(mean = rt_log_mean, sd = rt_log_sd ))
```



```{r, echo = FALSE}

rt_log_mean <- convert_to_logmean(2, 1)
rt_log_sd <- convert_to_logsd(2, 1) 

latent_period_fixed <- dist_spec(
  mean = 4, sd = 2, 
  max = 20, distribution = "gamma"
)

log_mean <- convert_to_logmean(2, 1)
log_sd <- convert_to_logsd(2, 1) 
reporting_delay_fixed <- dist_spec(
  mean = log_mean, sd = log_sd,
  max = 10, distribution = "lognormal"
)

generation_time_fixed <- dist_spec(
  mean = 3.6, sd = 3.1,
  max = 20, distribution = "lognormal"
)
```

*Note : in the code below fixed distributions are used instead of variable. This is to speed up computation time. It is generally recommended to use variable distributions that account for additional uncertainty.*

```{r, message = FALSE, eval = TRUE}
reported_cases <- cases[1:90,]
estimates <- epinow(
  reported_cases = reported_cases,
  generation_time = generation_time_opts(generation_time_fixed),
  delays = delay_opts(latent_period_fixed + reporting_delay_fixed),
  rt = rt_opts(prior = list(mean = rt_log_mean, sd = rt_log_sd))
)

```


### Results

We can extract a summary of the key transmissibility features at the latest date in the data:

```{r}
summary(estimates)
```


+ From the summary of our analysis we see that the expected change in daily cases is `r summary(estimates)$estimate[summary(estimates)$measure=="Expected change in daily cases"]` with the estimated new confirmed cases `r summary(estimates)$estimate[summary(estimates)$measure=="New confirmed cases by infection date"]`.

+ The effective reproduction number $R_t$ estimate (on the last date of the data) is `r summary(estimates)$estimate[summary(estimates)$measure=="Effective reproduction no."]`. 

+ The exponential growth rate of case numbers is `r summary(estimates)$estimate[summary(estimates)$measure=="Rate of growth"]`.

+ The doubling time (the time taken for case numbers to double) is `r summary(estimates)$estimate[summary(estimates)$measure=="Doubling/halving time (days)"]`.


::::::::::::::::::::::::::::::::::::: callout
### `Expected change in daily cases` 

A factor describing whether the daily cases are either:

+ Increasing,
+ Likely increasing,
+ Stable,
+ Likely decreasing,
+ Decreasing.


::::::::::::::::::::::::::::::::::::::::::::::::

We can also extract and visualise estimates of the effective reproduction number and growth rate through time:

```{r}
estimates$plots$R
estimates$plots$growth_rate
```



## Quantify transmission heterogeneity

The outbreak data of the start of the COVID-19 pandemic from the United Kingdom from the R package `{incidence2}` includes the region in which the cases were recorded. To find regional estimates of the effective reproduction number and cases, we must format the data to have three columns:

+ `date` : the date,
+ `region` : the region, 
+ `confirm` : number of confirmed cases for a region on a given date.

```{r}
regional_cases <- incidence2::covidregionaldataUK[, c("date", "cases_new", "region")]
colnames(regional_cases) <- c("date", "confirm", "region")

# extract the first 90 dates for all regions
dates <- sort(unique(regional_cases$date))[1:90]
regional_cases <- regional_cases[which(regional_cases$date %in% dates),]

head(regional_cases)
```

To find regional estimates, we use the same inputs as `epinow()` to the function `regional_epinow()`:

```{r, message = FALSE, eval = TRUE}
estimates_regional <- regional_epinow(
  reported_cases = regional_cases,
  generation_time = generation_time_opts(generation_time_fixed),
  delays = delay_opts(latent_period_fixed + reporting_delay_fixed),
  rt = rt_opts(prior = list(mean = rt_log_mean, sd = rt_log_sd))
)

region_rt$summary$summarised_results$table
```


## Summary

The reliability of the estimates depends on the quality of the data and appropriate choice of delay distributions. `EpiNow2` can also be used to estimate infections and create forecasts using case data. In the next lesson we will learn how to make forecasts and investigate some of the additional inference options available in `EpiNow2`. 

::::::::::::::::::::::::::::::::::::: keypoints 

- Transmissibility metrics can be estimated from case data after accounting for delays
- Uncertainty can be accounted for in delay distributions

::::::::::::::::::::::::::::::::::::::::::::::::
