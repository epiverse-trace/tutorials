---
title: 'Simulating transmission'
teaching: 45 # teaching time in minutes
exercises: 30 # exercise time in minutes 
---

```{r setup, echo= FALSE}
library(epidemics);library(ggplot2)
```


:::::::::::::::::::::::::::::::::::::: questions 

- How do I generate predictions of disease trajectories?
- What model structure do I need?
- What inputs do I require for a model simulation? 

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

Using the R package `epidemics`, learn how to: 

- load an existing model structure,
- load an existing social contact matrix,
- run a model simulation.

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites
+ Prior knowledge of ordinary differential equations is beneficial 
:::::::::::::::::::::::::::::::::


## Introduction

Mathematical models are useful tools for generating future trajectories of disease spread. Models can be used to evaluate the implementation of non-pharmaceutical and pharmaceutical interventions while accounting for factors such as age.

In this tutorial, we will use the R package [`epidemics`](https://github.com/epiverse-trace/epidemics) to generate trajectories of disease spread. By the end of this tutorial, you will be able to generate the trajectory below showing the number of infectious individuals in different age categories through time.

```{r traj, echo = FALSE, message= FALSE}
# load contact and population data from socialmixr::polymod
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)

# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# initial conditions: one in every 1 million is infected
initial_i <- 1e-6
initial_conditions_inf <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)

initial_conditions_free <- c(
  S = 1, E = 0, I = 0, R = 0, V = 0
)

# build for all age groups
initial_conditions <- rbind(
  initial_conditions_inf,
  initial_conditions_free,
  initial_conditions_free
)
rownames(initial_conditions) <- rownames(contact_matrix)

# prepare the population to model as affected by the epidemic
uk_population <- population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)

# simulate a pandemic, with an R0,
# an infectious period, and an pre-infectious period
influenza <- infection(
  name = "influenza",
  r0 = 1.5,
  preinfectious_period = 3,
  infectious_period = 7
)

# run an epidemic model using `epidemic()`
output <- epidemic_default_cpp(
  population = uk_population,
  infection = influenza,
  time_end = 600, increment = 1.0
)

ggplot(output[compartment == "infectious", ]) +
  geom_line(
    aes(time, value, colour = demography_group)
  ) +
  scale_colour_brewer(
    palette = "Dark2",
    labels = rownames(contact_matrix),
    name = "Age group"
  ) +
  scale_y_continuous(
    labels = scales::comma,
    name = "Infectious indivduals"
  ) +
  labs(
    x = "Model time (days)"
  ) +
  theme_classic() +
  theme(
    legend.position = "top"
  )

```


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

Inline instructor notes can help inform instructors of timing challenges
associated with the lessons. They appear in the "Instructor View"

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

The first step is to install the R packages `epidemics`.

```{r installation, eval = FALSE}
if(!require("pak")) install.packages("pak")
pak::pak("epiverse-trace/epidemics")
```


## Model structures
To generate predictions of infectious disease trajectories, we must first select a mathematical model to use.

In `epidemics` models are defined as either *epidemic* models or *outbreak* models. *Epidemic* models focus on directly transmitted diseases with pandemic potential (such as influenza and Covid), and *outbreak* models,  focus on diseases that are not expected to have pandemic potential (such as Ebola).

There is a library of epidemic and outbreak models to choose from in `epidemics`. Models are prefixed with either epidemic or outbreak, and suffixed by the infection name. In this tutorial, we will use the default epidemic model, `epidemic_default` which is described in the next section.


::::::::::::::::::::::::::::::::::::: callout
### Check model equations
When using existing model structures always check the model assumptions. Ask questions such as:

- How is transmission modelled?
- What interventions are modelled? 
- What state variables are there and how do they relate to assumptions about infection?

There can be subtle differences in model structures for the same infection/outbreak type which can be missed without studying the equations.
::::::::::::::::::::::::::::::::::::::::::::::::


### An epidemic model

The default epidemic model is an age-structured SEIR-V model described by a system of ordinary differential equations. For each age group $i$, individuals are classed as either susceptible $S$, infected but not yet infectious $E$, infectious $I$, recovered $R$ or vaccinated $V$. 

The model parameters and equations are as follows :

- transmission rate $\beta$,
- contact matrix $C$ containing the frequency of contacts between age groups (a square $i \times j$ matrix),
- rate of transition from exposed to infectious $\alpha$ (preinfectious period=$1/\alpha$),
- recovery rate $\gamma$ (infectious period = $1/\gamma$),
- time dependent vaccination rate $\nu_t$.


$$
\begin{aligned}
\frac{dS_i}{dt} & = - \beta S_i \sum_j C_{i,j} I_j -\nu_{t} S_i \\
\frac{dE_i}{dt} &= \beta S_i\sum_j C_{i,j} I_j - \alpha E_i \\
\frac{dI_i}{dt} &= \alpha E_i - \gamma I_i \\
\frac{dR_i}{dt} &=\gamma I_i \\
\frac{dV_i}{dt} &=\nu_{t} S_i\\
\end{aligned}
$$

From the model structure we see that :

- the contact matrix $C$ allows for heterogeneity in contacts between age groups,
- there is no loss of immunity (there are no flows out of the recovered or vaccinated states),
- only susceptibles are vaccinated.

To generate trajectories using our model, we need the following :  

1.  parameter values,
2.  contact matrix,
3.  demographic structure,
4.  initial conditions. 

## Model parameters

To run our model we need to specify the model parameters. For this tutorial, we will assume there are no interventions (including vaccination). Therefore, the parameters we need values for are: 

- transmission rate $\beta$,
- rate of transition from exposed to infectious $\alpha$ (preinfectious period=$1/\alpha$),
- recovery rate $\gamma$ (infectious period=$1/\gamma$).

We will learn how to specify the contact matrix $C$ in the next section. 


In `epidemics`, we use the function `infection` to create an infection object containing the values of, $R_0$, the preinfectious period ($1/\alpha$) and the infectious period ($1/\gamma$) as follows.

```{r, eval = FALSE}
influenza <- infection(
  name = "influenza",
  r0 = 1.5,
  preinfectious_period = 3,
  infectious_period = 7
)

```

::::::::::::::::::::::::::::::::::::: callout
### The basic reproduction number $R_0$
The basic reproduction number, $R_0$, for the SEIR model is: 

$$ R_0 = \frac{\beta}{\gamma}.$$ 

Therefore, we can rewrite the transmission rate, $\beta$, as:

$$ \beta = R_0 \gamma.$$


::::::::::::::::::::::::::::::::::::::::::::::::


<!-- ### Load parameters from previous tutorials  -->


### Contact matrix

The contact matrix is a square matrix consisting of rows/columns equal to the number age groups. Each element represents the frequency of contacts between age groups. 

If we believe that transmission of an infection is driven by contact, and that contact rates are very different for different age groups, then specifying a contact matrix allows us to account for age specific rates of transmission. 

Contact matrices can be estimated from surveys or contact data, or synthetic ones can be used. We will use the R package [`socialmixr`](https://cran.r-project.org/web/packages/socialmixr/) to load in a contact matrix estimated from POLYMOD survey data [(Mossong et al. 2008)](https://doi.org/10.1371/journal.pmed.0050074).


::::::::::::::::::::::::::::::::::::: challenge 

## Load contact and population data

Using the R package `socialmixr`, run the following lines of R code to obtain the contact matrix for the United Kingdom for the year age bins:

+ age between 0 and 20 years,
+ age between 20 and 40,
+ 40 years and over.

```r
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  survey = polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)
contact_matrix
```

:::::::::::::::::::::::: solution 

## Output
 
```{r polymod_uk, echo = FALSE}
 polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)
contact_matrix
```


:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::

The result is a square matrix with rows and columns for each age group. Contact matrices can be loaded from other sources, but they must be in the correct format to be used in `epidemics`.

::::::::::::::::::::::::::::::::::::: callout
### Why would a contact matrix be non-symmetric?

One of the arguments of the function `contact_matrix` is `symmetric=TRUE`. This means that the total number of contacts of age group 1 with age group 2, should be the same as the total number of contacts of age group 2 and age group 1 (see the `socialmixr` [vignette](https://cran.r-project.org/web/packages/socialmixr/vignettes/socialmixr.html) for more detail). However, when contact matrices are estimated from surveys or other sources, the *reported* number of contacts may differ by age group resulting in a non-symmetric contact matrix [(Prem et al 2021)](https://doi.org/10.1371/journal.pcbi.1009098).
::::::::::::::::::::::::::::::::::::::::::::::::


## Generating trajectories

We have prepared our parameter values, contact matrix and demography vector. Now we must set the initial conditions, prepare the population and run the model. 

### Initial conditions

The initial conditions are the proportion of individuals in each disease state $S$, $E$, $I$ and $R$ for each age group at time 0. In this example, we have three age groups age between 0 and 20 years, age between 20 and 40 years and over. Let's assume that in the youngest age category, one in a million individuals are infectious, and the remaining age categories are infection free. 

The initial conditions in the first age category are $S(0)=1-\frac{1}{1,000,000}$, $E(0) =0$, $I(0)=\frac{1}{1,000,000}$, $R(0)=0$. This is specified as a vector as follows:

```{r initial_inf}
initial_i <- 1e-6
initial_conditions_inf <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)
```

For the age categories that are free from infection, the initial conditions are $S(0)=1$, $E(0) =0$, $I(0)=0$, $R(0)=0$. We specify this as follows,

```{r initial_free}
initial_conditions_free <- c(
  S = 1, E = 0, I = 0, R = 0, V = 0
)
```

We combine the three initial conditions vectors into one matrix, 

```{r initial condtions}
# build for all age groups
initial_conditions <- rbind(
  initial_conditions_inf,
  initial_conditions_free,
  initial_conditions_free
)
rownames(initial_conditions) <- rownames(contact_matrix)
initial_conditions
```

### Running the model

To run the model we need the following inputs:

- an infection object, 
- a population object,
- an optional number of time steps.

We have already created our infection object `influenza`. The population object requires a vector containing the demographic structure of the population. The demographic vector must be a named vector containing the number of individuals in each age group of our given population. In this example, we can extract the demographic information from the `contact_data` object that we obtained using the `socialmixr` package.

```{r demography}
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)
demography_vector
```

To create our population object, we call the function `population` specifying a name, the contact matrix, the demography vector and the initial conditions.

```{r population}
uk_population <- population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)
```

No we are ready to run our model. We will specify `time_end=600` to run the model for 600 days.

```{r run_model}
output <- epidemic_default_cpp(
  population = uk_population,
  infection = influenza,
  time_end = 600
)
head(output)
```
Our model output consists of the number of individuals in each compartment in each age group through time. We can visualise the infectious individuals only (those in the $I$ class) through time.

```{r visualise}
ggplot(output[compartment == "infectious", ]) +
  geom_line(
    aes(time, value, colour = demography_group)
  ) +
  scale_colour_brewer(
    palette = "Dark2",
    labels = rownames(contact_matrix),
    name = "Age group"
  ) +
  scale_y_continuous(
    labels = scales::comma,
    name = "Infectious indivduals"
  ) +
  labs(
    x = "Model time (days)"
  ) +
  theme_classic() +
  theme(
    legend.position = "top"
  )

```


::::::::::::::::::::::::::::::::::::: callout
### Time increments

Note that there is a default argument of `increment = 1`. This relates to the time step of the ODE solver. When the parameters and maximum number of time steps is days, the default increment is one day.

The choice of increment will depend on the timescale of the parameters, and the rate at which events can occur. In general, the increment should smaller than the fastest event. For example, if parameters are on a monthly time scale, but some events will occur within a month, then the increment should be less than one month.

::::::::::::::::::::::::::::::::::::::::::::::::

## Summary 

In this tutorial, we have learnt how to generate disease trajectories using a mathematical model. Once a model has been chosen, the parameters and other inputs must be specified in the correct way to perform model simulations. In the next tutorial, we will consider how to choose the right model for different tasks. 

::::::::::::::::::::::::::::::::::::: keypoints 

- Disease trajectories can be generated using the R package `epidemics`
- Contact matrices can be estimated from different sources

::::::::::::::::::::::::::::::::::::::::::::::::
